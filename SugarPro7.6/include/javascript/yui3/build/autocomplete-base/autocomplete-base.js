/*
     YUI 3.15.0 (build 834026e)
     Copyright 2014 Yahoo! Inc. All rights reserved.
     Licensed under the BSD License.
     http://yuilibrary.com/license/
     */
YUI.add('autocomplete-base',function(Y,NAME){var Escape=Y.Escape,Lang=Y.Lang,YArray=Y.Array,YObject=Y.Object,isFunction=Lang.isFunction,isString=Lang.isString,trim=Lang.trim,INVALID_VALUE=Y.Attribute.INVALID_VALUE,_FUNCTION_VALIDATOR='_functionValidator',_SOURCE_SUCCESS='_sourceSuccess',ALLOW_BROWSER_AC='allowBrowserAutocomplete',INPUT_NODE='inputNode',QUERY='query',QUERY_DELIMITER='queryDelimiter',REQUEST_TEMPLATE='requestTemplate',RESULTS='results',RESULT_LIST_LOCATOR='resultListLocator',VALUE='value',VALUE_CHANGE='valueChange',EVT_CLEAR='clear',EVT_QUERY=QUERY,EVT_RESULTS=RESULTS;function AutoCompleteBase(){}
AutoCompleteBase.prototype={initializer:function(){Y.before(this._bindUIACBase,this,'bindUI');Y.before(this._syncUIACBase,this,'syncUI');this.publish(EVT_CLEAR,{defaultFn:this._defClearFn});this.publish(EVT_QUERY,{defaultFn:this._defQueryFn});this.publish(EVT_RESULTS,{defaultFn:this._defResultsFn});},destructor:function(){this._acBaseEvents&&this._acBaseEvents.detach();delete this._acBaseEvents;delete this._cache;delete this._inputNode;delete this._rawSource;},clearCache:function(){this._cache&&(this._cache={});return this;},sendRequest:function(query,requestTemplate){var request,source=this.get('source');if(query||query===''){this._set(QUERY,query);}else{query=this.get(QUERY)||'';}
if(source){if(!requestTemplate){requestTemplate=this.get(REQUEST_TEMPLATE);}
request=requestTemplate?requestTemplate.call(this,query):query;source.sendRequest({query:query,request:request,callback:{success:Y.bind(this._onResponse,this,query)}});}
return this;},_bindUIACBase:function(){var inputNode=this.get(INPUT_NODE),tokenInput=inputNode&&inputNode.tokenInput;if(tokenInput){inputNode=tokenInput.get(INPUT_NODE);this._set('tokenInput',tokenInput);}
if(!inputNode){Y.error('No inputNode specified.');return;}
this._inputNode=inputNode;this._acBaseEvents=new Y.EventHandle([inputNode.on(VALUE_CHANGE,this._onInputValueChange,this),inputNode.on('blur',this._onInputBlur,this),this.after(ALLOW_BROWSER_AC+'Change',this._syncBrowserAutocomplete),this.after('sourceTypeChange',this._afterSourceTypeChange),this.after(VALUE_CHANGE,this._afterValueChange)]);},_syncUIACBase:function(){this._syncBrowserAutocomplete();this.set(VALUE,this.get(INPUT_NODE).get(VALUE));},_createArraySource:function(source){var that=this;return{type:'array',sendRequest:function(request){that[_SOURCE_SUCCESS](source.concat(),request);}};},_createFunctionSource:function(source){var that=this;return{type:'function',sendRequest:function(request){var value;function afterResults(results){that[_SOURCE_SUCCESS](results||[],request);}
if((value=source(request.query,afterResults))){afterResults(value);}}};},_createObjectSource:function(source){var that=this;return{type:'object',sendRequest:function(request){var query=request.query;that[_SOURCE_SUCCESS](YObject.owns(source,query)?source[query]:[],request);}};},_functionValidator:function(value){return value===null||isFunction(value);},_getObjectValue:function(obj,path){if(!obj){return;}
for(var i=0,len=path.length;obj&&i<len;i++){obj=obj[path[i]];}
return obj;},_parseResponse:function(query,response,data){var facade={data:data,query:query,results:[]},listLocator=this.get(RESULT_LIST_LOCATOR),results=[],unfiltered=response&&response.results,filters,formatted,formatter,highlighted,highlighter,i,len,maxResults,result,text,textLocator;if(unfiltered&&listLocator){unfiltered=listLocator.call(this,unfiltered);}
if(unfiltered&&unfiltered.length){filters=this.get('resultFilters');textLocator=this.get('resultTextLocator');for(i=0,len=unfiltered.length;i<len;++i){result=unfiltered[i];text=textLocator?textLocator.call(this,result):result.toString();results.push({display:Escape.html(text),raw:result,text:text});}
for(i=0,len=filters.length;i<len;++i){results=filters[i].call(this,query,results.concat());if(!results){return;}
if(!results.length){break;}}
if(results.length){formatter=this.get('resultFormatter');highlighter=this.get('resultHighlighter');maxResults=this.get('maxResults');if(maxResults&&maxResults>0&&results.length>maxResults){results.length=maxResults;}
if(highlighter){highlighted=highlighter.call(this,query,results.concat());if(!highlighted){return;}
for(i=0,len=highlighted.length;i<len;++i){result=results[i];result.highlighted=highlighted[i];result.display=result.highlighted;}}
if(formatter){formatted=formatter.call(this,query,results.concat());if(!formatted){return;}
for(i=0,len=formatted.length;i<len;++i){results[i].display=formatted[i];}}}}
facade.results=results;this.fire(EVT_RESULTS,facade);},_parseValue:function(value){var delim=this.get(QUERY_DELIMITER);if(delim){value=value.split(delim);value=value[value.length-1];}
return Lang.trimLeft(value);},_setEnableCache:function(value){this._cache=value?{}:null;},_setLocator:function(locator){if(this[_FUNCTION_VALIDATOR](locator)){return locator;}
var that=this;locator=locator.toString().split('.');return function(result){return result&&that._getObjectValue(result,locator);};},_setRequestTemplate:function(template){if(this[_FUNCTION_VALIDATOR](template)){return template;}
template=template.toString();return function(query){return Lang.sub(template,{query:encodeURIComponent(query)});};},_setResultFilters:function(filters){var acFilters,getFilterFunction;if(filters===null){return[];}
acFilters=Y.AutoCompleteFilters;getFilterFunction=function(filter){if(isFunction(filter)){return filter;}
if(isString(filter)&&acFilters&&isFunction(acFilters[filter])){return acFilters[filter];}
return false;};if(Lang.isArray(filters)){filters=YArray.map(filters,getFilterFunction);return YArray.every(filters,function(f){return!!f;})?filters:INVALID_VALUE;}else{filters=getFilterFunction(filters);return filters?[filters]:INVALID_VALUE;}},_setResultHighlighter:function(highlighter){var acHighlighters;if(this[_FUNCTION_VALIDATOR](highlighter)){return highlighter;}
acHighlighters=Y.AutoCompleteHighlighters;if(isString(highlighter)&&acHighlighters&&isFunction(acHighlighters[highlighter])){return acHighlighters[highlighter];}
return INVALID_VALUE;},_setSource:function(source){var sourceType=this.get('sourceType')||Lang.type(source),sourceSetter;if((source&&isFunction(source.sendRequest))||source===null||sourceType==='datasource'){this._rawSource=source;return source;}
if((sourceSetter=AutoCompleteBase.SOURCE_TYPES[sourceType])){this._rawSource=source;return Lang.isString(sourceSetter)?this[sourceSetter](source):sourceSetter(source);}
Y.error("Unsupported source type '"+sourceType+"'. Maybe autocomplete-sources isn't loaded?");return INVALID_VALUE;},_sourceSuccess:function(data,request){request.callback.success({data:data,response:{results:data}});},_syncBrowserAutocomplete:function(){var inputNode=this.get(INPUT_NODE);if(inputNode.get('nodeName').toLowerCase()==='input'){inputNode.setAttribute('autocomplete',this.get(ALLOW_BROWSER_AC)?'on':'off');}},_updateValue:function(newVal){var delim=this.get(QUERY_DELIMITER),insertDelim,len,prevVal;newVal=Lang.trimLeft(newVal);if(delim){insertDelim=trim(delim);prevVal=YArray.map(trim(this.get(VALUE)).split(delim),trim);len=prevVal.length;if(len>1){prevVal[len-1]=newVal;newVal=prevVal.join(insertDelim+' ');}
newVal=newVal+insertDelim+' ';}
this.set(VALUE,newVal);},_afterSourceTypeChange:function(e){if(this._rawSource){this.set('source',this._rawSource);}},_afterValueChange:function(e){var newVal=e.newVal,self=this,uiChange=e.src===AutoCompleteBase.UI_SRC,delay,fire,minQueryLength,query;if(!uiChange){self._inputNode.set(VALUE,newVal);}
minQueryLength=self.get('minQueryLength');query=self._parseValue(newVal)||'';if(minQueryLength>=0&&query.length>=minQueryLength){if(uiChange){delay=self.get('queryDelay');fire=function(){self.fire(EVT_QUERY,{inputValue:newVal,query:query,src:e.src});};if(delay){clearTimeout(self._delay);self._delay=setTimeout(fire,delay);}else{fire();}}else{self._set(QUERY,query);}}else{clearTimeout(self._delay);self.fire(EVT_CLEAR,{prevVal:e.prevVal?self._parseValue(e.prevVal):null,src:e.src});}},_onInputBlur:function(e){var delim=this.get(QUERY_DELIMITER),delimPos,newVal,value;if(delim&&!this.get('allowTrailingDelimiter')){delim=Lang.trimRight(delim);value=newVal=this._inputNode.get(VALUE);if(delim){while((newVal=Lang.trimRight(newVal))&&(delimPos=newVal.length-delim.length)&&newVal.lastIndexOf(delim)===delimPos){newVal=newVal.substring(0,delimPos);}}else{newVal=Lang.trimRight(newVal);}
if(newVal!==value){this.set(VALUE,newVal);}}},_onInputValueChange:function(e){var newVal=e.newVal;if(newVal!==this.get(VALUE)){this.set(VALUE,newVal,{src:AutoCompleteBase.UI_SRC});}},_onResponse:function(query,e){if(query===(this.get(QUERY)||'')){this._parseResponse(query||'',e.response,e.data);}},_defClearFn:function(){this._set(QUERY,null);this._set(RESULTS,[]);},_defQueryFn:function(e){this.sendRequest(e.query);},_defResultsFn:function(e){this._set(RESULTS,e[RESULTS]);}};AutoCompleteBase.ATTRS={allowBrowserAutocomplete:{value:false},allowTrailingDelimiter:{value:false},enableCache:{lazyAdd:false,setter:'_setEnableCache',value:true},inputNode:{setter:Y.one,writeOnce:'initOnly'},maxResults:{value:0},minQueryLength:{value:1},query:{readOnly:true,value:null},queryDelay:{value:100},queryDelimiter:{value:null},requestTemplate:{setter:'_setRequestTemplate',value:null},resultFilters:{setter:'_setResultFilters',value:[]},resultFormatter:{validator:_FUNCTION_VALIDATOR,value:null},resultHighlighter:{setter:'_setResultHighlighter',value:null},resultListLocator:{setter:'_setLocator',value:null},results:{readOnly:true,value:[]},resultTextLocator:{setter:'_setLocator',value:null},source:{setter:'_setSource',value:null},sourceType:{value:null},tokenInput:{readOnly:true},value:{value:''}};AutoCompleteBase._buildCfg={aggregates:['SOURCE_TYPES'],statics:['UI_SRC']};AutoCompleteBase.SOURCE_TYPES={array:'_createArraySource','function':'_createFunctionSource',object:'_createObjectSource'};AutoCompleteBase.UI_SRC=(Y.Widget&&Y.Widget.UI_SRC)||'ui';Y.AutoCompleteBase=AutoCompleteBase;},'3.15.0',{"optional":["autocomplete-sources"],"requires":["array-extras","base-build","escape","event-valuechange","node-base"]});
/*
 * Your installation or use of this SugarCRM file is subject to the applicable
 * terms available at
 * http://support.sugarcrm.com/06_Customer_Center/10_Master_Subscription_Agreements/.
 * If you do not agree to all of the applicable terms or do not have the
 * authority to bind the entity as an authorized representative, then do not
 * install or use this SugarCRM file.
 *
 * Copyright (C) SugarCRM Inc. All rights reserved.
 *//*;
 * SugarCRM Javascript API
 *///create the SUGAR namespace if one does not exist already
var SUGAR=SUGAR||{};SUGAR.Api=function(){function l(e){var l,c,h,p,d,v,m,g,y,b=window.open,w=null,E=null,S=null,x=[],T={},N=0;h=e&&e.keyValueStore,l=e&&e.serverUrl||"/rest/v10",m=e&&e.defaultErrorHandler||null,c=e&&e.platform||"",p=e&&e.clientID||"sugar",d=(e&&e.timeout||30)*1e3,g=!1,y=!e||!e.disableBulkApi,e&&e.externalLoginUICallback&&_.isFunction(e.externalLoginUICallback)&&(b=e.externalLoginUICallback);if(h){if(!$.isFunction(h.set)||!$.isFunction(h.get)||!$.isFunction(h.cut))throw new Error("Failed to initialize Sugar API: key/value store provider is invalid");w=h.get("AuthAccessToken"),E=h.get("AuthRefreshToken"),S=h.get("DownloadToken"),$.isFunction(h.on)&&h.on("cache:clean",function(e){e(["AuthAccessToken","AuthRefreshToken","DownloadToken"])})}v=!1,e&&e.reset&&(r=0);var C=function(e){e?(w=e.access_token,E=e.refresh_token,S=e.download_token,h&&(h.set("AuthAccessToken",w),h.set("AuthRefreshToken",E),h.set("DownloadToken",S))):(w=null,E=null,S=null,h&&(h.cut("AuthAccessToken"),h.cut("AuthRefreshToken"),h.cut("DownloadToken")))},k=function(e,t,n){return function(r,s,o){var a=new u(t,s,o),f=function(){if(x.length==0||e.refreshingToken(t.params.url))n.error?n.error(a):$.isFunction(e.defaultErrorHandler)&&e.defaultErrorHandler(a);else for(var r=0;r<x.length;++r)x[r]._oerror&&x[r]._oerror(a);e.setRefreshingToken(!1)},l,c=!0;if(e.needRefreshAuthToken(t.params.url,a.code)){if(t._dequeuing){t._oerror&&t._oerror(a),e.resetAuth();return}x.push(t),e.setRefreshingToken(!0),e.login(null,{refresh:!0},{complete:function(){if(c)while(l=x.shift())l._ocomplete&&l._ocomplete.call(this,l)},success:function(){c=!1,e.setRefreshingToken(!1),i(function(){while(l=x.shift())l._dequeuing=!0,l.execute(e.getOAuthToken())})},error:f})}else e.needQueue(t.params.url)?x.push(t):g&&a.status==401&&a.payload&&a.payload.url?(e.isLoginRequest(t.params.url)||x.push(t),e.setRefreshingToken(!0),$(window).on("message",function(t){if(!t.originalEvent.origin||t.originalEvent.origin!=window.location.origin)return;$(window).on("message",null),authData=$.parseJSON(t.originalEvent.data),(!authData||!authData.access_token)&&f(),e.setRefreshingToken(!1),C(authData),i(function(){while(l=x.shift())l.execute(e.getOAuthToken())})}),b(a.payload.url,"_blank","width=600,height=400,centerscreen=1,resizable=1")):f()}};return{clientID:p,serverUrl:l,defaultErrorHandler:m,timeout:d,debug:!1,abortRequest:function(e){var t=T[e];t&&(t.aborted=!0,t.xhr&&t.xhr.abort())},getRequest:function(e){return T[e]},setRefreshTokenSuccessCallback:function(e){_.isFunction(e)&&(i=e)},call:function(e,n,r,i,o){var u,f,l=t[e],c=this,h=this.getOAuthToken(),p={type:l,dataType:"json",headers:{},timeout:this.timeout,contentType:"application/json"};o=o||{},i=i||{},o.url||(p.url=n),i.success&&(p.success=function(e,t){u.status=e&&e.status?e.status:t,i.success(e,u)}),p.complete=function(){delete T[u.uid],!v&&i.complete&&i.complete(u)},o.iframe===!0?h&&(r=r||{},r["OAuth-Token"]=h,p.data=r):r&&(e=="create"||e=="update"||e=="delete")&&(p.data=JSON.stringify(r)),p.type!=="GET"&&(p.processData=!1),u=new a(_.extend(p,o),this.debug),p.error=k(c,u,i),u._oerror=i.error,u._ocomplete=i.complete,u.uid=N++,T[u.uid]=u,f=[h,o.skipMetadataHash?null:this.getMetadataHash(),o.skipMetadataHash?null:this.getUserprefHash()];if(this.isLoginRequest(n))u.execute();else if(this.isAuthRequest(n))u.execute(h);else if(p.bulk&&y){var d=s[p.bulk]||[];s[p.bulk]||(s[p.bulk]=d),d.push({request:u,args:f})}else u.execute.apply(u,f);return u},triggerBulkCall:function(e){if(!y)return;e=e||!0;var t=s[e],n=[],r=_.last(this.serverUrl.split("/"));if(!t)return;_.each(t,function(e){var t=e.request.params,i=e.args,s=i[0],o=i[1],u=i[2];s&&(t.headers=t.headers||{},t.headers["OAuth-Token"]=s),o&&(t.headers=t.headers||{},t.headers["X-Metadata-Hash"]=o),u&&(t.headers=t.headers||{},t.headers["X-Userpref-Hash"]=u),t.url!=""&&(t.url=r+t.url.substring(this.serverUrl.length)),n.push(t)},this),this.call("create",this.buildURL("bulk"),{requests:n},{success:function(e,n){_.each(t,function(t,r){var i=t.request,s=e[r],o=s.contents||{},u=new f(s,n),a;i.xhr=u,i.aborted===!0||o.error?(i.status="error",_.isFunction(i.params.error)&&i.params.error.call(i.params,i,"error",u.statusText)):_.isFunction(i.params.success)&&i.params.success.call(i.params,o,"success"),_.isFunction(i.params.complete)&&i.params.complete.call(i.params,i)})}}),s[e]=null},clearBulkQueue:function(){s={}},buildURL:function(e,t,r,i){i=i||{};var s=[],o;return s.push(this.serverUrl),e&&s.push(e),t!="create"&&r&&r.id&&s.push(r.id),r&&r.link&&t!="file"&&s.push("link"),t&&$.inArray(t,n)===-1&&s.push(t),r&&r.relatedId&&s.push(r.relatedId),r&&t=="file"&&r.field&&(s.push(r.field),r.fileId&&s.push(r.fileId)),i.filter&&t!=="export"&&s.push("filter"),o=s.join("/"),_.each(i,function(e,t){(e===null||e===undefined)&&delete i[t]}),i=$.param(i),i.length>0&&(o+="?"+i),o},buildFileURL:function(e,t){var n={};return t=t||{},e.field&&t.htmlJsonFormat!==!1&&(n.format="sugar-html-json"),t.deleteIfFails===!0&&(n.delete_if_fails=!0),t.passOAuthToken&&(n.oauth_token=this.getOAuthToken()),t.passDownloadToken&&(n.download_token=this.getDownloadToken()),_.isUndefined(t.forceDownload)||(n.force_download=t.forceDownload?1:0),t.cleanCache===!0&&(n[(new Date).getTime()]=1),t.platform!==undefined?n.platform=t.platform:c&&(n.platform=c),t.keep===!0&&(n.keep=1),this.buildURL(e.module,"file",e,n)},getOAuthToken:function(){return h?h.get("AuthAccessToken")||w:w},getRefreshToken:function(){return h?h.get("AuthRefreshToken")||E:E},getDownloadToken:function(){return h?h.get("DownloadToken")||S:S},getMetadataHash:function(){return h?h.get("meta:hash"):null},getUserprefHash:function(){return h?h.get("userpref:hash"):null},getMetadata:function(e,t,n,r,i){i=i||{};var s=i.params||{},o,u;return t&&(s.type_filter=t.join(",")),n&&(s.module_filter=n.join(",")),c&&(s.platform=c),o="read",i&&i.getPublic&&(o="public"),u=this.buildURL("metadata",o,null,s),this.call(o,u,null,r)},records:function(e,t,n,r,i,s){var o=this.buildURL(t,e,n,r);return this.call(e,o,n,i,s)},relationships:function(e,t,n,r,i,s){var o=this.buildURL(t,n.link,n,r);return this.call(e,o,n.related,i,s)},favorite:function(e,t,n,r,i){var s=n?"favorite":"unfavorite",o=this.buildURL(e,s,{id:t});return this.call("update",o,null,r,i)},follow:function(e,t,n,r,i){r=r||{},i=i||{};var s=n?"create":"delete",o=n?"subscribe":"unsubscribe",u=this.buildURL(e,o,{id:t});return this.call(s,u,null,r,i)},enumOptions:function(e,t,n,r){var i=this.buildURL(e+"/enum/"+t);return this.call("read",i,null,n,r)},fileDownload:function(e,t,n){n=n||{};var r={};return r.success=function(r){n.iframe?n.iframe.prepend('<iframe class="hide" src="'+e+'"></iframe>'):window.location.href=e,_.isFunction(t.success)&&t.success.apply(arguments)},_.isFunction(t.error)&&(r.error=t.error),_.isFunction(t.complete)&&(r.complete=t.complete),this.call("read",this.buildURL("ping"),{},r,{processData:!1})},file:function(e,t,n,r,i){var s={files:n,processData:!1};if(e==="delete")s.iframe=!1;else if(!i||i.iframe!==!1)s.iframe=!0,i=i||{},i.passOAuthToken=!0;if(!i||i.deleteIfFails!==!1)i=i||{},i.deleteIfFails=!0;return r.success=_.wrap(r.success,function(e,t,n){t.error&&_.isFunction(r.error)?r.error(t):_.isFunction(e)&&e(t)}),this.call(e,this.buildFileURL(t,i),null,r,s)},exportRecords:function(e,t,n,r){var i=this,s=this.buildURL(e.module,"record_list");return r=r||{},this.call("create",s,{records:e.uid},{success:function(s){e=_.omit(e,["uid","module"]),r.platform!==undefined?e.platform=r.platform:c&&(e.platform=c),i.fileDownload(i.buildURL(s.module_name,"export",{relatedId:s.id},e),n,{iframe:t})}})},search:function(e,t,n){var r=this.buildURL(null,"search",null,e);return this.call("read",r,null,t,n)},login:function(e,t,n){var r,i,s,o,u;return e=e||{},n=n||{},i=function(e){C(e),n.success&&n.success(e)},s=function(e){C(),n.error&&n.error(e)},t&&t.refresh?r=_.extend({grant_type:"refresh_token",client_id:this.clientID,client_secret:"",refresh_token:this.getRefreshToken(),platform:c?c:"base"},t):(r=_.extend({grant_type:"password",username:e.username,password:e.password,client_id:this.clientID,platform:c?c:"base",client_secret:""},t),r.client_info=t),o="create",u=this.buildURL("oauth2","token",r),this.call(o,u,r,{success:i,error:s,complete:n.complete})},me:function(e,t,n,r){var i=this.buildURL("me",e,t,n);return this.call(e,i,t,r)},css:function(e,t,n){var r={platform:e,themeName:t},i=this.buildURL("css","read",{},r);return this.call("read",i,{},n)},logout:function(e){e=e||{};var t={token:this.getOAuthToken(),refresh_token:this.getRefreshToken()},n=this.buildURL("oauth2","logout",t),r=e.complete;return e.complete=function(){C(),r&&r()},this.call("create",n,t,e)},ping:function(e,t,n){return this.call("read",this.buildURL("ping",e,null,{platform:c}),null,t,_.extend({skipMetadataHash:!0},n||{}))},signup:function(e,t,n){var r=e;r.client_info=t;var i="create",s=this.buildURL("Leads","register",r);return this.call(i,s,r,n)},verifyPassword:function(e,t){var n={password_to_verify:e},r="create",i=this.buildURL("me/password",r);return this.call(r,i,n,t)},updatePassword:function(e,t,n){var r={new_password:t,old_password:e},i="update",s=this.buildURL("me/password",i);return this.call(i,s,r,n)},info:function(e){var t=this.buildURL("ServerInfo");return this.call("read",t,null,e)},isAuthenticated:function(){return typeof this.getOAuthToken()=="string"&&this.getOAuthToken().length>0},resetAuth:function(){C()},needRefreshAuthToken:function(e,t){return!v&&typeof this.getRefreshToken()=="string"&&this.getRefreshToken().length>0&&!this.isAuthRequest(e)&&t==="invalid_grant"},needQueue:function(e){return v&&!this.isAuthRequest(e)},isAuthRequest:function(e){return(new RegExp("/oauth2/")).test(e)},isLoginRequest:function(e){return(new RegExp("/oauth2/token")).test(e)},refreshingToken:function(e){return v&&this.isAuthRequest(e)},setRefreshingToken:function(e){v=e},setExternalLogin:function(e){g=e},getStateProperty:function(e){return o[e]},setStateProperty:function(e,t){o[e]=t},clearStateProperty:function(e){delete o[e]},resetState:function(){o={}}}}var e,t={read:"GET",update:"PUT",create:"POST","delete":"DELETE"},n=["read","update","create","delete"],r=0,i=function(e){e()},s={},o={},u=function(e,t,n){e=e||{},e.xhr=e.xhr||{},this.request=e,this.status=e.xhr.status,this.responseText=e.xhr.responseText,this.textStatus=t,this.errorThrown=n;if(typeof this.responseText=="string"&&this.responseText.length>0)try{var r=this.request.xhr.getResponseHeader("Content-Type");r&&r.indexOf("application/json")===0&&(this.payload=JSON.parse(this.responseText),this.code=this.payload.error,this.message=this.payload.error_message)}catch(i){}};_.extend(u.prototype,{toString:function(){return"HTTP error: "+this.status+"\ntype: "+this.textStatus+"\nerror: "+this.errorThrown+"\nresponse: "+this.responseText+"\ncode: "+this.code+"\nmessage: "+this.message}});var a=function(e,t){this.params=e,this.debug=t,this.numExecuted=0,this.state={}};_.extend(a.prototype,{execute:function(e,t,n){e&&(this.params.headers=this.params.headers||{},this.params.headers["OAuth-Token"]=e),t&&(this.params.headers=this.params.headers||{},this.params.headers["X-Metadata-Hash"]=t),n&&(this.params.headers=this.params.headers||{},this.params.headers["X-Userpref-Hash"]=n),this.state=_.extend(this.state,o);if(this.debug){console.log("====== Ajax Request Begin ======"),console.log(this.params.type+" "+this.params.url);var i=this.params.data?JSON.parse(this.params.data):null;i&&i.password&&(i.password="***"),console.log("Payload: ",this.params.data?i:"N/A");var s=$.extend({},this.params);delete s.data,console.log("params: ",s),console.log("====== Request End ======")}if(this.numExecuted==0){var u=this.params.complete;this.params.complete=function(){r--,_.isFunction(u)&&u.apply(this,arguments)}}this.xhr=$.ajax(this.params),r++,this.numExecuted++}});var f=function(e,t){var n=e.contents||{};this.status=e.status||200,this.statusText=e.status_text||"",this.responseText=_.isObject(n)?JSON.stringify(n):n,this.readyState=4,this._parent=t.xhr,this.headers=e.headers};return _.extend(f.prototype,{isResolved:function(){return this._parent.isResolved()},getResponseHeader:function(e){return this.headers[e]},getAllResponseHeaders:function(){return _.reduce(this.headers,function(e,t,n){return e.concat(n+": "+t+"\n")},"")}}),{getInstance:function(t){return e||this.createInstance(t)},createInstance:function(t){return e=new l(t),e},getCallsInProgressCount:function(){return r},HttpError:u,HttpRequest:a}}();var SUGAR=SUGAR||{};SUGAR.App=function(){function r(e){var t=_.uniqueId("SugarApp_");return e=e||{},_.extend({appId:t,$rootEl:n(e.el||"body"),$contentEl:n(e.contentEl||"#content"),additionalComponents:{}},this,Backbone.Events)}var e,t={},n=function(e){return e instanceof $?e:$(e)};return{init:function(t){e=e||_.extend(this,new r(t)),_.extend(e,e.beforeEvent),e.events.register("app:init",this),e.events.register("app:start",this),e.events.register("app:sync",this),e.events.register("app:sync:complete",this),e.events.register("app:sync:error",this),e.events.register("app:login:success",this),e.events.register("app:logout",this),e.events.register("app:view:change",this),e.events.register("app:locale:change",this),e.events.register("lang:direction:change",this),e.cache&&e.cache.init(this);var n=e.utils.capitalize(e.config?e.config.appId:"")+"Controller",i=this[n]||this.Controller;return this.controller=new i,e.api=SUGAR.Api.getInstance({defaultErrorHandler:t&&t.defaultErrorHandler?t.defaultErrorHandler:SUGAR.App.error.handleHttpError,serverUrl:e.config.serverUrl,platform:e.config.platform,timeout:e.config.serverTimeout,keyValueStore:e[e.config.authStore||"cache"],clientID:e.config.clientID,disableBulkApi:e.config.disableBulkApi,externalLoginUICallback:t&&t.externalLoginUICallback}),this._init(t),e},_init:function(t){var n=this,r=function(r){if(!e)return;if(r){n.trigger("app:sync:error",r);return}n._initModules(),n._loadConfig(),t.silent||e.trigger("app:init",n),t.callback&&_.isFunction(t.callback)&&t.callback(e)},i=function(t){e.config.loadCss?e.loadCss(t):t()};if(e.config.syncConfig!==!1){var s={getPublic:!0};i(function(){e.metadata.sync(r,s)})}else i(function(){r()});return e},_initModules:function(){_.each(t,function(e){_.isFunction(e.init)&&e.init(this)},this)},_loadConfig:function(){e.config=e.config||{},e.config=_.extend(e.config,e.metadata.getConfig())},loadCss:function(t){e.api.css(e.config.platform,e.config.themeName,{success:function(n){e.config.loadCss==="url"?_.each(n.url,function(t){$("<link>").attr({rel:"stylesheet",href:e.utils.buildUrl(t)}).appendTo("head")}):_.each(n.text,function(e){$("<style>").html(e).appendTo("head")}),_.isFunction(t)&&t()}})},start:function(){e.events.registerAjaxEvents(),e.trigger("app:start",this),e.routing.start()},destroy:function(){Backbone.history&&Backbone.history.stop(),e=null},augment:function(n,r,i){this[n]=r,t[n]=r,i&&r.init&&_.isFunction(r.init)&&r.init.call(e)},sync:function(t){var n=this;t=t||{};if(t.getPublic)return n.syncPublic(t);async.waterfall([function(r){n.isSynced=!1,n.trigger("app:sync");var i=!t.noUserUpdate&&(t.language||e.cache.get("langHasChanged"));if(i){var s=t.language||e.lang.getLanguage();n.user.updateLanguage(s,r),e.cache.cut("langHasChanged")}else r()},function(e){async.parallel([function(e){n.user.load(e)},function(e){n.metadata.sync(function(t){n.data.declareModels(),e(t)},t)}],function(t){e(t)})}],function(e){e?n.trigger("app:sync:error",e):(n.isSynced=!0,n.trigger("app:sync:complete")),_.isFunction(t.callback)&&t.callback(e)})},syncPublic:function(e){e=e||{},e.getPublic=!0,this.metadata.sync(e.callback,e)},navigate:function(t,n,r){var i,s,o;t=t||e.controller.context,n=n||t.get("model"),s=n.id,o=t.get("module")||n.module,i=this.router.buildRoute(o,s,r),this.router.navigate(i,{trigger:!0})},login:function(t,n,r){r=r||{},n=n||{},n.current_language=e.lang.getLanguage(),e.api.login(t,n,{success:function(t){e.trigger("app:login:success",t),r.success&&r.success(t)},error:function(t){e.error.handleHttpError(t),r.error&&r.error(t)},complete:r.complete})},logout:function(t,n){var r,i;return t=t||{},r=t.complete,i=t.error,t.complete=function(t){e.trigger("app:logout",n),r&&r(t)},t.error=function(t){e.error.handleHttpError(t),i&&i(t)},e.api.logout(t)},isServerCompatible:function(e){var t=this.config.supportedServerFlavors,n=this.config.minServerVersion,r,i,s;return _.isEmpty(t)&&!n?!0:(r=!!(_.isEmpty(t)||e&&_.contains(t,e.flavor)),i=!!(!n||e&&this.utils.versionCompare(e.version,n,">=")),r&&i?!0:(i?s={code:"server_flavor_incompatible",label:"ERR_SERVER_FLAVOR_INCOMPATIBLE"}:s={code:"server_version_incompatible",label:"ERR_SERVER_VERSION_INCOMPATIBLE"},s.server_info=e,s))},modules:t}}(),function(app){var _doWhenStack=[],_doWhenLocked=!1,_doWhenInterval=!1,_doWhenretryCount=0,_startDoWhenInterval=function(){_doWhenInterval||(_doWhenInterval=window.setInterval(app.utils._doWhenCheck,50))};app.augment("utils",{capitalize:function(e){return e?e.charAt(0).toUpperCase()+(e.length>1?e.substr(1):""):""},capitalizeHyphenated:function(e){return this._classify(e,"-")},classify:function(e){return this._classify(e,"_")},_classify:function(e,t){var n=this,r="";t=t||"_";if(!e||e.lastIndexOf(t)===-1)r=n.capitalize(e);else{var i=e.split(t);_.each(i,function(e){r+=n.capitalize(e)})}return r},extendClass:function(e,t,n,r,i){var s=null,o=null;return _.isObject(r)?(t=_.isObject(r.extendsFrom)?r.extendsFrom:e[i+"Custom"+r.extendsFrom]||e[i+r.extendsFrom]||e["Custom"+r.extendsFrom]||e[r.extendsFrom]||t,s=e[n]=t.extend(r)):s=e[n]=t,s},formatNumber:function(e,t,n,r,i){t=t||n;var s=e;if(_.isNaN(e)||!_.isFinite(e))return s;if(_.isString(e)){e=parseFloat(e,10);if(_.isNaN(e))return s}return _.isNumber(e)?(e=parseFloat(e.toFixed(t),10).toFixed(n).toString(),_.isString(r)&&_.isString(i)?this.addNumberSeperators(e,r,i):e):(!_.isNull(e)&&!_.isUndefined(e)&&app.logger.warn("formatNumber: invalid variable type ("+typeof s+")"),s)},formatNumberLocale:function(e){return this.formatNumber(e,app.user.getPreference("decimal_precision")||2,app.user.getPreference("decimal_precision")||2,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".")},formatName:function(e,t){return t.replace(/(f)|(l)|(s)/g,function(t,n,r,i){return n?e.first_name||"":r?e.last_name||"":i&&(e.last_name||e.first_name)?e.salutation||"":""}).replace(/^( )?,/g,"").replace(/, $/g,"").replace(/  /g," ").trim()},formatNameModel:function(e,t,n){n=n||app.user.getPreference("default_locale_name_format"),t=t||{};var r=app.metadata.getModule(e)||{fields:{}},i=r.nameFormat||{};return _.reduce(n.split(""),function(e,n){if(n<"a"||n>"z")return e+n;if(!i[n])return e;var s,o=r.fields[i[n]]&&r.fields[i[n]].type==="enum"&&!_.isEmpty(r.fields[i[n]].options);if(o){var u=app.lang.getAppListStrings(r.fields[i[n]].options);s=u[t[i[n]]]||t[i[n]]||""}return e+(s||t[i[n]]||"")},"").replace(/^( )?,/g,"").replace(/, $/g,"").replace(/  /g," ").trim()},formatNameLocale:function(e){return this.formatName(e,app.user.getPreference("default_locale_name_format"))},addNumberSeperators:function(e,t,n){var r=e.split("."),i=/(\d+)(\d{3})/;while(t!==""&&i.test(r[0]))r[0]=r[0].toString().replace(i,"$1"+t+"$2");return r[0]+(r.length>1&&r[1]!==""?n+r[1]:"")},unformatNumberString:function(e,t,n,r){r=r||!1;if(typeof t=="undefined"||typeof n=="undefined")return e;_.isString(e)||(_.isFinite(e)?e.toString():e="");if(t!==""){var i=new RegExp("\\"+t,"g");e=e.replace(i,"")}e=e.replace(n,".");if(e.length>0&&r){var s=parseFloat(e);if(s==e)return s}return e},unformatNumberStringLocale:function(e,t){return this.unformatNumberString(e,app.user.getPreference("number_grouping_separator")||",",app.user.getPreference("decimal_separator")||".",t)},formatString:function(e,t){for(var n in t)e=e.replace("{"+n+"}",t[n]);return e},regexEscape:function regexEscape(e){if(typeof regexEscape.specialRegExp=="undefined"){var t=["/",".","*","+","?","|","(",")","[","]","{","}","\\","-",",","^","$","#"];regexEscape.specialRegExp=new RegExp("(\\"+t.join("|\\")+")","g")}return e.replace(regexEscape.specialRegExp,"\\$1")},generateUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})},cookie:{setCookie:function(t,n,r){var i=new Date,s;i.setDate(i.getDate()+r),s=escape(n)+(r===null?"":"; expires="+i.toUTCString()),document.cookie=t+"="+s},getCookie:function(e){var t,n,r,i=document.cookie.split(";");for(t=0;t<i.length;t++){n=i[t].substr(0,i[t].indexOf("=")),r=i[t].substr(i[t].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,"");if(n===e)return unescape(r)}}},isValidEmailAddress:function(e){return/^.+@.+$/ig.test(e)},doWhen:function(e,t,n,r){_doWhenStack.push({check:e,fn:t,obj:n,overrideContext:r}),_doWhenretryCount=50,_startDoWhenInterval()},_doWhenCheck:function(){if(_doWhenStack.length===0){_doWhenretryCount=0,_doWhenInterval&&(clearInterval(_doWhenInterval),_doWhenInterval=null);return}if(_doWhenLocked)return;_doWhenLocked=!0;var tryAgain=$.isReady;tryAgain||(tryAgain=_doWhenretryCount>0&&_doWhenStack.length>0);var notAvail=[],executeItem=function(e,t){t.overrideContext&&(t.overrideContext===!0?e=t.obj:e=t.overrideContext),t.fn&&t.fn.call(e,t.obj)},i,len,item,test;for(i=0,len=_doWhenStack.length;i<len;i+=1)item=_doWhenStack[i],item&&(test=item.check,typeof test=="string"&&eval(test)||typeof test=="function"&&test()?(executeItem(this,item),_doWhenStack[i]=null):notAvail.push(item));_doWhenretryCount--;if(tryAgain){for(i=_doWhenStack.length-1;i>-1;i--)item=_doWhenStack[i],(!item||!item.check)&&_doWhenStack.splice(i,1);_startDoWhenInterval()}else _doWhenInterval&&(clearInterval(_doWhenInterval),_doWhenInterval=null);_doWhenLocked=!1},versionCompare:function(e,t,n){return version_compare(e,t,n)},extendFrom:function(e,t,n){e.prototype=new t,_.extend(e.prototype,n)},deepCopy:function(e){return _.isObject(e)?JSON.parse(JSON.stringify(e)):e},compareBeans:function(e,t){var n;if(e.module!==t.module)throw Error("Only beans of the same module can be compared.");return n=_.reduce(e.attributes,function(n,r,i){return i!=="id"&&i.indexOf("_")!==0&&!this.areBeanValuesEqual(r,t.get(i))&&this.hasDefaultValueChanged(i,e)&&n.push(i),n},[],this),n},areBeanValuesEqual:function(e,t){var n=function(e){return _.isObject(e)&&_.isEmpty(e)?"":!_.isObject(e)&&(_.isUndefined(e)||_.isNull(e))?"":e};return e=n(e),t=n(t),_.isObject(e)&&_.isEqual(e,t)||!_.isObject(e)&&e===t},hasDefaultValueChanged:function(e,t){var n=t._defaults?t._defaults[e]:"";return!this.areBeanValuesEqual(n,t.get(e))},buildUrl:function(e){return e.indexOf("http")!==0&&!_.isEmpty(app.config.siteUrl)&&(e=app.config.siteUrl.replace(/\/+$/,"")+"/"+e),e},getParentLayout:function(e){var t;return e.view&&e.view.layout?t=e.view.layout:t=e.layout,t},isSortable:function(e,t){var n=app.metadata.getModule(e).fields[t.name],r=!0;return n&&!_.isUndefined(n.sortable)&&(r=n.sortable),t&&!_.isUndefined(t.sortable)&&(r=t.sortable),r},hardRefresh:function(){window.location.reload(!0)},isDirectionRTL:function(e){var t="A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿Ⰰ-﬜﷾-﹯﻽-￿",n="֑-߿יִ-﷽ﹰ-ﻼ",r=new RegExp("^[^"+t+"]*["+n+"]");return r.test(e)}})}(SUGAR.App),function(e){var t=moment;_.extend(t,{InvalidException:function(e,t){this.name="InvalidException",this.message=e,this.date=t},_cachedFormats:{},_serverDateFormat:"YYYY-MM-DD",convertFormat:function(e){if(t._cachedFormats[e])return t._cachedFormats[e];var n={d:"DD",m:"MM",Y:"YYYY",H:"HH",h:"hh",i:"mm"},r=e;return _.each(n,function(e,t){r=r.replace(t,e)}),t._cachedFormats[e]=r,r},compare:function(e,n){var r=moment(e),i=moment(n);if(!r.isValid())throw new t.InvalidException("Invalid date passed for comparison.",e);if(!i.isValid())throw new t.InvalidException("Invalid date passed for comparison.",n);return r.isBefore(i)?-1:r.isAfter(i)?1:0},getUserDateFormat:function(t){return t=t||e.user,this.convertFormat(t.getPreference("datepref"))},getUserTimeFormat:function(t){return t=t||e.user,this.convertFormat(t.getPreference("timepref"))}});var n={};_.extend(t,{parse:function(e,t){var n=new Date("Jan 1, 1970 00:00:00"),r="",i,s,o,u,a,f;if(e instanceof Date)return e;t||(t=this.guessFormat(e));if(t===!1)return/^\d+$/.test(e)?new Date(e):!1;i=$.trim(e),t=$.trim(t)+" ";for(s=0;s<t.length;s++){o=t.charAt(s);if(o===":"||o==="/"||o==="-"||o==="."||o===" "||o==="a"||o==="A"){u=i.indexOf(o),u===-1&&(u=i.length),a=i.substring(0,u),i=i.substring(u+1);switch(r){case"m":if(!(a>0&&a<13))return!1;n.setMonth(a-1);break;case"d":if(!(a>0&&a<32))return!1;n.setDate(a);break;case"Y":if(a>0==0)return!1;n.setYear(a);break;case"h":f=t.substring(t.length-4),a=parseInt(a,10);var l=$.trim(f.toLowerCase());if(l==="i a"||l===o+"ia"){var c=i.substring(i.length-2).toLowerCase();c==="pm"?a<12&&(a+=12):c==="am"&&a===12&&(a=0)}n.setHours(a);break;case"H":n.setHours(a);break;case"i":a=a.substring(0,2),n.setMinutes(a);break;case"s":n.setSeconds(a)}r=""}else r=o}return n},guessFormat:function(e){if(typeof e!="string")return!1;var t="",n,r,i,s,o,u,a,f;e.indexOf(" ")!==-1&&(t=e.substring(e.indexOf(" ")+1,e.length),e=e.substring(0,e.indexOf(" "))),n="/";if(e.indexOf("/")===-1)if(e.indexOf("-")!==-1)n="-";else{if(e.indexOf(".")===-1)return!1;n="."}r=e.split(n),i="";if(r[0].length===4)i="Y"+n+"m"+n+"d";else{if(r[2].length!==4)return!1;i="m"+n+"d"+n+"Y"}return s="",o=[],t!==""&&(o.push("i"),u=":",t.indexOf(".")===2&&(u="."),t.split(u).length===3&&o.push("s"),a="",f=t.substring(t.length-2,t.length),f.toLowerCase()==="am"||f.toLowerCase()==="pm"?(o.unshift("h"),f.toLowerCase()===f?a="lower":a="upper"):o.unshift("H"),s=o.join(u),t.indexOf(" ")!==-1&&(s+=" "),a&&a==="upper"?s+="A":a&&a==="lower"&&(s+="a"),i=i+" "+s),i},parseFormat:function(e){if(!(e in n)){var t={},r,i;for(r=0;r<e.length;r++){i=e.charAt(r);switch(i){case"m":case"n":t.month=i;break;case"d":case"j":t.day=i;break;case"Y":t.year=i;break;case"H":case"h":case"g":t.hours=i;break;case"i":t.minutes=i;break;case"s":t.seconds=i;break;case"A":case"a":t.amPm=i;break;default:}}n[e]=t}return n[e]},format:function(e,t){if(!_.isDate(e))return"";var n="",r,i,s,o,u,a;for(r=0;r<t.length;r++){i=t.charAt(r);switch(i){case"\\":n+=t.charAt(r+1),r++;break;case"m":case"n":u=e.getMonth()+1,n+=u<10&&i==="m"?"0"+u:u;break;case"d":case"j":s=e.getDate(),n+=s<10&&i==="d"?"0"+s:s;break;case"Y":n+=e.getFullYear();break;case"H":case"h":case"g":o=e.getHours();if(i==="h"||i==="g")o=o>12?o-12:o,o=o===0?12:o;n+=o<10&&i!=="g"?"0"+o:o;break;case"i":u=e.getMinutes(),n+=u<10?"0"+u:u;break;case"s":a=e.getSeconds(),n+=a<10?"0"+a:a;break;case"a":case"A":e.getHours()<12?n+=i==="a"?"am":"AM":n+=i==="a"?"pm":"PM";break;default:n+=i}}return n},roundTime:function(e){if(!e.getMinutes)return 0;var t=e.getMinutes();return t<1?t=0:t<16?t=15:t<31?t=30:t<46?t=45:(t=0,e.setHours(e.getHours()+1)),e.setMinutes(t),e},UTCtoLocalTime:function(e){return e instanceof Date?new Date(this.toUTC(e)):e},UTCtoTimezone:function(e,t){return e instanceof Date&&undefined!==t&&null!==t?(t=parseFloat(t)*60*60*1e3,t-=e.getTimezoneOffset()*60*1e3*-1,new Date(this.toUTC(e)+t)):e},toUTC:function(e){if(e instanceof Date){var t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),i=e.getHours(),s=e.getMinutes(),o=e.getSeconds(),u=e.getMilliseconds();return Date.UTC(t,n,r,i,s,o,u)}return e},getRelativeTimeLabel:function(e){var t=new Date,n=t.getTime()<e.getTime(),r=n?e-t:t-e,i=1e3,s=i*60,o=s*60,u=o*24,a={str:"",value:undefined};return isNaN(r)||r<0?a:r<i*2?(a.str="LBL_TIME_AGO_NOW",a):r<s?(a.str=n?"LBL_TIME_UNTIL_SECONDS":"LBL_TIME_AGO_SECONDS",a.value=Math.floor(r/i),a):r<s*2?(a.str=n?"LBL_TIME_UNTIL_MINUTE":"LBL_TIME_AGO_MINUTE",a):r<o?(a.str=n?"LBL_TIME_UNTIL_MINUTES":"LBL_TIME_AGO_MINUTES",a.value=Math.floor(r/s),a):r<o*2?(a.str=n?"LBL_TIME_UNTIL_HOUR":"LBL_TIME_AGO_HOUR",a):r<u?(a.str=n?"LBL_TIME_UNTIL_HOURS":"LBL_TIME_AGO_HOURS",a.value=Math.floor(r/o),a):r>u&&r<u*2?(a.str=n?"LBL_TIME_UNTIL_DAY":"LBL_TIME_AGO_DAY",a):r<u*365?(a.str=n?"LBL_TIME_UNTIL_DAYS":"LBL_TIME_AGO_DAYS",a.value=Math.floor(r/u),a):(a.str=n?"LBL_TIME_UNTIL_YEAR":"LBL_TIME_AGO_YEAR",a)},parseDisplayDefault:function(e,t){var n,r,i,s,o,u,a,f,l=t?t:new Date,c,h,p,d;if(!e)return e;u=function(e,t){var n=e.getDate();return e.setMonth(e.getMonth()+t),e.getDate()<n&&(e.setDate(1),e.setDate(e.getDate()-1)),e},a=function(e){var t,n,r,i;t=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],n=l.getDay(),e=e.toLowerCase();for(var r=7;r--;)if(e===t[r]){e=r<=n?r+7:r;break}return i=e-n,i},n={day:function(e){return new Date(l.setDate(l.getDate()+e))},week:function(e){return new Date(l.setDate(l.getDate()+e*7))},month:function(e){return u(l,e)},year:function(e){return u(l,e*12)},now:function(){return l},"next monday":function(){return new Date(l.setDate(l.getDate()+a("monday")))},"next friday":function(){return new Date(l.setDate(l.getDate()+a("friday")))},"first of next month":function(){l.setDate(1);var e=l.setMonth(l.getMonth()+1);return new Date(e)}},e&&e.indexOf("&")>=0?(i=e.split("&"),s=i[0],o=i[1]):s=e;if(s.match(/\b(now|day|week|month|year)/g)){s.indexOf("now")===0?h="now":s.indexOf("first day of next month")!==-1?h="firstnextmonth":(p=s.split(" "),c=p[0],h=p[1]);if(h.match("now"))r=n.now();else if(h.match("firstnextmonth"))r=n["first of next month"]();else if(h.match("days?"))r=n.day(parseInt(c,10));else if(h.match("weeks?"))r=n.week(parseInt(c,10));else if(h.match("months?"))r=n.month(parseInt(c,10));else if(h.match("years?"))r=n.year(parseInt(c,10));else{if(!n[s])return;r=n[s]()}}else{if(!n[s])return;r=n[s]()}return f=function(e){var t,n,r;t=/^(\d\d?).(\d{2}).?([ap]m)?$/.exec(o),t&&t.length>2&&(n=t[1],n&&(t[3]==="pm"?n<12&&(n=parseInt(n,10)+12):n==="12"&&(n="0"),e.setHours(parseInt(n,10))),r=t[2],r&&e.setMinutes(parseInt(r,10)))}(r),r},toDatepickerFormat:function(e){if(_.isUndefined(e)||!e)return"";var t,n={y:"yy",Y:"yyyy",m:"mm",d:"dd"};return t=e.replace(/[yYmd]/g,function(e){return n[e]}),t},stripIsoTimeDelimterAndTZ:function(e){if(!_.isUndefined(e)&&e)return e.replace("T"," ").substr(0,19)},isIso:function(e){var t,n;t=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/);if(t)return!0;if(e.match(/[T\+Z ]/g)){n=e.match(/^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])/);if(n)return!0}return!1},compareDates:function(n,r){return e.logger.warn("date.compareDates() was called and is deprecated. Please update code to use date.compare()"),t.compare(n,r)},isDateAfter:function(n,r){return e.logger.warn("date.isDateAfter() was called and is deprecated. Please update code to use date(date1).isAfter(date2)"),t(n).isAfter(r)},isDateBefore:function(n,r){return e.logger.warn("date.isDateBefore() was called and is deprecated. Please update code to use date(date1).isBefore(date2)"),t(n).isBefore(r)},isDateOn:function(n,r){return e.logger.warn("date.isDateOn() was called and is deprecated. Please update code to use date.isSame()"),t(n).isSame(r)},isDateBetween:function(n,r,i,s){return e.logger.warn("date.isDateBetween() was called and is deprecated. Please update code to use date.isBetween()"),t(n).isBetween(r,i,s)}}),_.extend(t.fn,{formatUser:function(e,n){var r=t.getUserDateFormat(n);return e||(r+=" "+t.getUserTimeFormat(n)),this.format(r)},formatServer:function(e){var n=e&&t._serverDateFormat;return this.format(n)},isBetween:function(e,t,n){n=_.isUndefined(n)?!0:n;var r=this.isAfter(e)&&this.isBefore(t);return n&&!r&&(r=this.isSame(e)||this.isSame(t)),r}}),_.extend(t.duration.fn,{format:function(){var t=[],n=this.minutes(),r=this.hours(),i=Math.floor(this.asDays());return i>0&&(t.push(i),t.push(e.lang.get(i===1?"LBL_DURATION_DAY":"LBL_DURATION_DAYS"))),r>0&&(t.push(r),t.push(e.lang.get(r===1?"LBL_DURATION_HOUR":"LBL_DURATION_HOURS"))),n>0&&(t.push(n),t.push(e.lang.get(n===1?"LBL_DURATION_MINUTE":"LBL_DURATION_MINUTES"))),t.join(" ")}}),e.augment("date",t)}(SUGAR.App),function(e){e.augment("file",function(){return{checkFileFieldsAndProcessUpload:function(t,n,r,i){e.logger.warn("app.file.checkFileFieldsAndProcessUpload is deprecated as of 7.6.0."),n=n||{},r=r||{},i=_.isUndefined(i)?!0:i;var s=this._getAttachmentFields(t);s.length>0?(i&&e.alert.show("upload",{level:"process",title:"LBL_UPLOADING",autoclose:!1}),this._recursiveFileUpload
(s,t.model,n,r,i)):n.success&&n.success({})},_recursiveFileUpload:function(t,n,r,i,s,o){o=o||{};var u,a;if(t.length===0){r.success&&r.success(o);return}u=$(t.shift()),a=u.attr("name"),n.uploadFile(a,u,{field:a,success:_.bind(function(u){_.extend(o,u),t.length===0?(e.alert.dismiss("upload"),r.success&&r.success(o)):this._recursiveFileUpload(t,n,r,i,s,o)},this),error:_.bind(function(t){i&&i.deleteIfFails!==!1&&n.unset("id",{silent:!0}),s&&e.alert.dismiss("upload"),this._triggerFieldValidationError(t,n,a),r.error&&r.error(t)},this)},i)},_triggerFieldValidationError:function(e,t,n){var r={};r[n]={},t.trigger("error:validation:"+n,r),t.trigger("error:validation",r)},_getAttachmentFields:function(e){return _.filter(e.$(":file"),function(e){var t=$(e),n=t.val();return!_.isEmpty(n)&&!_.isEmpty(t.attr("name"))},this)}}}(),!1)}(SUGAR.App),function(e){e.augment("math",{_math:function(e,t,n,r,i){r=_.isFinite(r)&&r>=0?parseInt(r):6,i=i||!1;var s,o=Math.pow(10,r),u=parseFloat(t)*o,a=_.isUndefined(n)?undefined:parseFloat(n)*o;switch(e){case"round":s=Math.round(u)/o;break;case"add":s=(u+a)/o;break;case"sub":s=(u-a)/o;break;case"mul":s=this.round(u*a/o/o,r,i);break;case"div":s=this.round(u/a,r,i);break;default:return t}return i&&!_.isString(s)?s.toFixed(r):s},round:function(e,t,n){return this._math("round",e,null,t,n)},add:function(e,t,n,r){return this._math("add",e,t,n,r)},sub:function(e,t,n,r){return this._math("sub",e,t,n,r)},mul:function(e,t,n,r){return this._math("mul",e,t,n,r)},div:function(e,t,n,r){return this._math("div",e,t,n,r)},isDifferentWithPrecision:function(t,n,r){var i=e.metadata.getConfig(),s=r||e.user.getPreference("decimal_precision"),r=_.isFinite(s)?s:i.defaultCurrencySignificantDigits||2,o=this._math("round",this.getDifference(t,n,!0),null,r),u=r===0?0:this._math("div",.1,Math.pow(10,r-1));return o===0?!1:o>=u},getDifference:function(e,t,n){var r=this._math("sub",e,t),n=_.isUndefined(n)?!1:n;return n?Math.abs(r):r}},!1)}(SUGAR.App),function(e){e.augment("currency",{getBaseCurrencyId:function(){return e.metadata.getBaseCurrencyId()},getBaseCurrency:function(){var t=e.metadata.getBaseCurrencyId(),n=e.metadata.getCurrency(t);return n.currency_id=t,n},getCurrenciesSelector:function(t){var n={};return _.each(e.metadata.getCurrencies(),function(e,r){n[r]=t(e)}),n},getCurrencySymbol:function(t){var n=e.metadata.getCurrency(t);return n?n.symbol:""},formatAmount:function(t,n,r,i,s,o){if(!_.isFinite(t))return t;var u,a=e.metadata.getConfig();return n=n||this.getBaseCurrencyId(),o=o||"",_.isFinite(r)||(_.isFinite(a.defaultCurrencySignificantDigits)?r=a.defaultCurrencySignificantDigits:r=2),s=s||a.defaultDecimalSeparator||".",i=_.isUndefined(i)?a.defaultNumberGroupingSeparator||",":i,u=this.getCurrencySymbol(n)||this.getCurrencySymbol(this.getBaseCurrencyId()),t=e.utils.formatNumber(t,r,r,i,s),u+o+t},formatAmountLocale:function(t,n,r){var i=e.user.getPreference("decimal_separator"),s=e.user.getPreference("number_grouping_separator");return r=_.isFinite(r)?r:e.user.getPreference("decimal_precision"),this.formatAmount(t,n,r,s,i)},unformatAmount:function(t,n,r,i){return i=i||!1,t=t.toString().replace(/^[^\d\.\,-]+/,""),e.utils.unformatNumberString(t,n,r,i)},unformatAmountLocale:function(t,n){var r,i,s=e.metadata.getConfig();return r=e.user.getPreference("decimal_separator")||s.defaultDecimalSeparator||".",i=e.user.getPreference("number_grouping_separator")||s.defaultNumberGroupingSeparator||",",this.unformatAmount(t,i,r,n)},convertAmount:function(t,n,r){var i,s;return n==r?e.math.round(t,undefined,!0):(i=e.metadata.getCurrency(n),s=e.metadata.getCurrency(r),this.convertWithRate(t,i.conversion_rate,s.conversion_rate))},convertToBase:function(e,t){return this.convertAmount(e,t,this.getBaseCurrencyId())},convertFromBase:function(e,t){return this.convertAmount(e,this.getBaseCurrencyId(),t)},convertWithRate:function(t,n,r){return n=n||1,r=r||1,e.math.mul(e.math.div(t,n,undefined,!0),r,undefined,!0)}},!1)}(SUGAR.App),function(e){_.extend(e,{beforeEvent:{before:function(e,t,n,r){var i=this._before=this._before||{};return i[e]=i[e]||[],i[e].push({fn:t,params:n,overrideContext:r}),this},triggerBefore:function(e,t){var n=!1;if(this._before&&this._before[e]){var r=this._before[e];for(var i=0;i<r.length;i++){var s=r[i],o=this;s.overrideContext&&(s.overrideContext===!0?o=s.params:o=s.overrideContext);var u=t;t&&s.params?u=_.extend({},t,s.params):u=s.params||t,s.fn&&(n=n||s.fn.call(o,u)===!1)}}return!n},offBefore:function(e,t,n){if(!e)return delete this._before;var r=this._before=this._before||{};if(!r[e])return!1;if(!t&&!n)return delete r[e];var i=r[e];for(var s=i.length-1;s>=0;s--){var o=i[s],u=this;o.overrideContext&&(o.overrideContext===!0?u=o.params:u=o.overrideContext),o.fn==t&&(!n||n==u)&&i.splice(s,1)}return!0}}})}(SUGAR.App),function(e){var t="",n=function(e){return t+e},r={store:stash,init:function(){t=e.config.env+":"+e.config.appId+":",e.events.register("cache:clean",this)},has:function(e){if(this.store===stash)return window.localStorage.getItem(n(e))!==null;this.store.has(n(e))},get:function(e){return this.store.get(n(e))},set:function(e,t){try{this.store.set(n(e),t)}catch(r){r.name.toLowerCase().indexOf("quota")>-1&&(this.clean(),this.store.set(n(e),t))}},add:function(e,t){try{this.store.add(n(e),t)}catch(r){r.name.toLowerCase().indexOf("quota")>-1&&(this.clean(),this.store.add(n(e),t))}},clean:function(){var e=[],t={};this.trigger("cache:clean",function(t){e=_.union(t,e)}),_.each(e,function(e){t[e]=this.get(e)},this),this.cutAll(),_.each(t,function(e,t){_.isUndefined(e)||this.set(t,e)},this)},cut:function(e){this.store.has(n(e))&&this.store.cut(n(e))},cutAll:function(e){if(e===!0)return this.store.cutAll();_.each(this.store.getAll(),function(e,n){n.indexOf(t)===0&&this.store.cut(n)},this)}};_.extend(r,Backbone.Events),e.augment("cache",r)}(SUGAR.App),function(e){e.augment("events",_.extend({register:function(e,t){t.on(e,function(){var t=[].slice.call(arguments,0);t.unshift(e),this.trigger.apply(this,t)},this)},unregister:function(e,t){e.off(t)},registerAjaxEvents:function(){var e=this;$(document).off("ajaxStop"),$(document).off("ajaxStart"),$(document).on("ajaxStart",function(t){e.trigger("ajaxStart",t)}),$(document).on("ajaxStop",function(t){e.trigger("ajaxStop",t)})}},Backbone.Events))}(SUGAR.App),function(e){var t={init:function(){this.initialize()},initialize:function(e){e=e||{},this.remoteLogging=e.remoteLogging||!1,this.statusCodes=e.statusCodes?_.extend(this.statusCodes,e.statusCodes):this.statusCodes,e.disableOnError||this.enableOnError()},_callCustomHandler:function(e,t,n){t?t.apply(this,_.union([e],n||[])):this.handleStatusCodesFallback(e)},_handleFineGrainedError:function(t,n){var r="handle"+e.utils.classify(t.code)+"Error";(this[r]||n||this.handleStatusCodesFallback).call(this,t)},statusCodes:{0:function(e){e.textStatus==="timeout"?this._callCustomHandler(e,this.handleTimeoutError):this.handleStatusCodesFallback(e)},400:function(e){this._handleFineGrainedError(e,this.handleUnspecified400Error)},401:function(e){this._handleFineGrainedError(e,this.handleUnauthorizedError)},403:function(e){this._callCustomHandler(e,this.handleForbiddenError)},404:function(e){this._callCustomHandler(e,this.handleNotFoundError,_.rest(arguments))},405:function(e){this._callCustomHandler(e,this.handleMethodNotAllowedError)},409:function(e){this._callCustomHandler(e,this.handleMethodConflictError)},412:function(e){this._callCustomHandler(e,this.handleHeaderPreconditionFailed)},422:function(e,t){e.model=t,this._callCustomHandler(e,this.handleValidationError,_.rest(arguments))},424:function(e,t){e.model=t,this._callCustomHandler(e,this.handleMethodFailureError,_.rest(arguments))},500:function(e){this._callCustomHandler(e,this.handleServerError)},503:function(e){this._callCustomHandler(e,this.handleServerError)}},remoteLogging:!1,errorName2Keys:{maxValue:"ERROR_MAXVALUE",minValue:"ERROR_MINVALUE",maxLength:"ERROR_MAX_FIELD_LENGTH",minLength:"ERROR_MIN_FIELD_LENGTH",datetime:"ERROR_DATETIME",required:"ERROR_FIELD_REQUIRED",email:"ERROR_EMAIL",primaryEmail:"ERROR_PRIMARY_EMAIL",duplicateEmail:"ERROR_DUPLICATE_EMAIL",number:"ERROR_NUMBER",isBefore:"ERROR_IS_BEFORE",isAfter:"ERROR_IS_AFTER",greaterThan:"ERROR_IS_GREATER_THAN",lessThan:"ERROR_IS_LESS_THAN"},getErrorString:function(t,n){var r=n.module||"";return e.lang.get(this.errorName2Keys[t]||t,r,n)},handleValidationError:function(t){var n=t.responseText,r=t.model;e.alert.dismissAll(),_.each(n,function(t,n){var r="";_.isObject(t)?_.each(t,function(e,t){r+="(Message) "+this.getErrorString(t,e)+"\n"},this):r=t,e.logger.debug("validation failed for field `"+n+"`:\n"+r)},this)},handleHttpError:function(t,n,r){e.error.statusCodes[t.status]?e.error.statusCodes[t.status].call(e.error,t,n,r):e.error.handleStatusCodesFallback(t)},handleUnhandledError:function(t,n,r){e.logger.fatal(t+" at "+n+" on line "+r)},handleStatusCodesFallback:function(t){e.logger.error(t.toString())},handleRenderError:function(t,n,r){var i="render_error_"+t.module+"_"+t.name,s="error",o,u;switch(n){case"_renderHtml":o=e.lang.get("ERR_RENDER_FAILED_TITLE"),u=[e.lang.get("ERR_RENDER_FAILED_MSG"),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"_renderField":o=e.lang.get("ERR_RENDER_FIELD_FAILED_TITLE"),u=[e.utils.formatString(e.lang.get("ERR_RENDER_FIELD_FAILED_MSG"),[r.name]),e.lang.get("ERR_CONTACT_TECH_SUPPORT")];break;case"view_render_denied":o=e.lang.get("ERR_NO_VIEW_ACCESS_TITLE"),s="warning",u=[e.utils.formatString(e.lang.get("ERR_NO_VIEW_ACCESS_MSG"),[t.module])];break;case"layout_render":o=e.lang.get("ERR_LAYOUT_RENDER_TITLE"),u=[e.lang.get("ERR_LAYOUT_RENDER_MSG")];break;default:o=e.lang.get("ERR_GENERIC_TITLE"),u=[e.lang.get("ERR_INTERNAL_ERR_MSG"),e.lang.get("ERR_CONTACT_TECH_SUPPORT")],e.logger.error("handleRenderError called for render error caught in "+n+", but we have no corresponding handler!")}e.alert.show(i,{level:s,title:o,messages:u})},enableOnError:function(e,t){var n,r=this;return this.overloaded?!1:(n=window.onerror,window.onerror=function(i,s,o){e?e.call(t):r.handleUnhandledError(i,s,o),n&&n()},this.overloaded=!0,!0)}};e.augment("error",t,!1)}(SUGAR.App),function(app){var _header="(function() {\n  var template = Handlebars.template, templates = Handlebars.templates = Handlebars.templates || {};\n",_footer="})();",_templates={},_sources={},_templateManager;_templateManager={init:function(){_templates=app.config.cacheMeta?app.cache.get("templates")||{}:{};var src="";_.each(_templates,function(e){src+=e});try{eval(_header+src+_footer)}catch(e){app.logger.error("Failed to eval templates retrieved from local storage:\n"+e)}},_add:function(e,t,n){var r=e[0],i=this.get(r,!1);if(i&&!n)return;i&&n&&_sources[r]!=t&&(_templates[r]=Handlebars.templates[r]=null),_sources[r]=t},_compile:function(e,t,n){return Handlebars.templates=Handlebars.templates||{},_templates[e[0]]=Handlebars.templates[e[0]]=n||!e[1]?this.compile(e[0],t):e[1],_templates[e[0]]},compile:function(key,src){try{_templates[key]="templates['"+key+"'] = template("+Handlebars.precompile(src)+");\n",eval(_header+_templates[key]+_footer)}catch(e){app.logger.error("Failed to compile or eval template "+key+".\n"+e)}return this.get(key,!1)||this.empty},get:function(e,t){return t=_.isUndefined(t)||t,t&&!Handlebars.templates[e]&&_sources[e]&&this._compile([e],_sources[e]),Handlebars.templates?Handlebars.templates[e]:null},_getView:function(e,t,n){var r=e+(t?"."+t:"");return[r,this.get(r,n)]},getView:function(e,t){return this._getView(e,t,!0)[1]},_getField:function(e,t,n,r,i,s){var o,u="f."+e+".",a=u+(n?n+".":"")+t;return n+=".",o=this.get(u+n+t,s)||this.get(u+t,s),!o&&!i&&(o=this.get(u+n+r,s)||this.get(u+r,s),o||(o=this.get("f.base."+t,s)||this.get("f.base."+r,s))),[a,o]},getField:function(e,t,n,r){return this._getField(e,t,n,r,!1,!0)[1]},_getLayout:function(e,t,n){var r="l."+(t?t+".":"")+e;return[r,this.get(r,n)]},getLayout:function(e,t){return this._getLayout(e,t,!0)[1]},setView:function(e,t,n,r){return this._add(this._getView(e,t,!1),n,r)},setField:function(e,t,n,r,i){return this._add(this._getField(e,t,n,null,!0,!1),r,i)},setLayout:function(e,t,n,r){return this._add(this._getLayout(e,t,!1),n,r)},set:function(e,t){e.views&&_.each(e.views,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){r=n==r?r:n+"."+r,this.setView(r,null,e,t)},this)},this),e.fields&&_.each(e.fields,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){this.setField(n,r,null,e,t)},this)},this),e.layouts&&_.each(e.layouts,function(e,n){n!="_hash"&&_.each(e.templates,function(e,r){r=n==r?r:n+"."+r,this.setLayout(r,null,e,t)},this)},this)},empty:function(){return""}},app.augment("template",_templateManager)}(SUGAR.App),function(e){e.Context=Backbone.Model.extend({initialize:function(e){Backbone.Model.prototype.initialize.call(this,e),this.id=this.cid,this.parent=null,this.children=[],this._fetchCalled=!1},clear:function(e){e=_.extend({clearAllListeners:!0},e||{}),_.each(this.children,function(t){t.clear(e)}),this.children=[],this.parent=null,_.each(this.attributes,function(t){t&&t.off===Backbone.Events.off&&(e.clearAllListeners?(t.off(),_.isFunction(t.dispose)&&t.dispose()):t.off(null,null,this))},this),delete e.clearAllListeners,this.off(),Backbone.Model.prototype.clear.call(this,e),this.resetLoadFlag()},resetLoadFlag:function(e){e=_.isUndefined(e)?!0:e,this._fetchCalled=!1,this.get("model")&&(this.get("model").dataFetched=!1),this.get("collection")&&(this.get("collection").dataFetched=!1),e&&_.each(this.children,function(e){e.resetLoadFlag()})},isCreate:function(){return this.get("create")===!0},getChildContext:function(t){var n,r=t.forceNew||!1;delete t.forceNew;var i=t.cid||t.name||t.link||t.module;i&&!r&&(n=_.find(this.children,function(e){return e.cid==i||e.get("link")==i||e.get("module")==i})),n||(n=e.context.getContext(t),this.children.push(n),n.parent=this);if(t.link){var s=this.get("model");n.set({parentModel:s,parentModule:s?s.module:null})}else t.module||n.set({module:this.get("module")});return this.trigger("context:child:add",n),n},prepare:function(e){if(!e&&(this.get("model")||this.get("collection")))return;var t=this.get("modelId"),n=this.get("create"),r=this.get("link");return this.set(r?this._prepareRelated(r,t,n):this._prepare(t,n)),this},_prepare:function(t,n){var r,i,s=this.get("module"),o=this.get("mixed"),u;return t?(r=e.data.createBean(s,{id:t}),u=[r]):n===!0?(r=e.data.createBean(s),u=[r]):r=e.data.createBean(s),i=o===!0?e.data.createMixedBeanCollection(u):e.data.createBeanCollection(s,u),{collection:i,model:r}},_prepareRelated:function(t,n,r){var i,s,o=this.get("parentModel");return o=o||e.data.createBean(this.get("parentModule"),{id:this.get("parentModelId")}),n?(i=e.data.createRelatedBean(o,n,t),s=e.data.createRelatedCollection(o,t,[i])):r===!0?(i=e.data.createRelatedBean(o,null,t),s=e.data.createRelatedCollection(o,t,[i])):(i=e.data.createRelatedBean(o,null,t),s=e.data.createRelatedCollection(o,t)),this.has("parentModule")||this.set({parentModule:o.module},{silent:!0}),this.has("module")||this.set({module:i.module},{silent:!0}),{parentModel:o,collection:s,model:i}},loadData:function(t){if(this.isDataFetched()||this.get("create")===!0)return;var n,r=this.get("modelId"),i=this.get("module"),s=e.config.orderByDefaults&&i?e.config.orderByDefaults[i]:null;t=t||{},n=r?this.get("model"):this.get("collection"),s&&n instanceof e.BeanCollection&&!n.orderBy&&(n.orderBy=s),n&&(n instanceof e.Bean||n instanceof e.BeanCollection)?(this.get("link")&&(t.relate=!0),this.get("dataView")&&_.isString(this.get("dataView"))&&(t.view=this.get("dataView")),this.get("fields")&&(t.fields=this.get("fields")),this.get("limit")&&(t.limit=this.get("limit")),this.get("module_list")&&(t.module_list=this.get("module_list")),this.get("viewed")&&(t.viewed=!0),t.context=this,n instanceof e.BeanCollection&&n.resetPagination(),this.get("skipFetch")!==!0&&n.fetch(t),this._fetchCalled=!0):e.logger.warn("Skipping fetch because model is not Bean, Bean Collection, or it is not defined, module: "+this.get("module"))},reloadData:function(e){this.resetLoadFlag(e.recursive),this.loadData(e)},isDataFetched:function(){var e=this.get("modelId")?this.get("model"):this.get("collection");return this._fetchCalled||e&&!!e.dataFetched}}),e.augment("context",{getContext:function(t){return new e.Context(t)}})}(SUGAR.App),function(e){var t=Backbone.View.extend({initialize:function(){this.context=e.context.getContext(),e.events.on("app:sync:complete",function(){e.api.setStateProperty("loadingAfterSync",!0),_.each(e.additionalComponents,function(e){e&&_.isFunction(e._setLabels)&&e._setLabels(),e.render()}),e.router.start(),e.api.clearStateProperty("loadingAfterSync")}),e.events.on("app:login:success",function(){e.sync()})},loadView:function(t){var n=this.layout;if(!e.triggerBefore("app:view:change"))return;this.context.clear({silent:!0}),this.context.set(t),this.context.prepare(),this.layout=e.view.createLayout({name:t.layout,module:t.module,context:this.context});if(n){var r=document.createDocumentFragment();r.appendChild(n.el)}e.$contentEl.append(this.layout.$el),(!t||t&&!t.skipFetch)&&this.layout.loadData(),this.layout.render(),n&&n.dispose(),e.trigger("app:view:change",t.layout,t)},loadAdditionalComponents:function(t){_.each(e.additionalComponents,function(e){e&&(e.remove(),e.dispose())}),e.additionalComponents={},_.each(t,function(t,n){t.target?(t.layout?e.additionalComponents[n]=e.view.createLayout({context:this.context,name:t.layout,el:this.$(t.target)}):e.additionalComponents[n]=e.view.createView({name:t.view||n,context:this.context,el:this.$(t.target)}),e.additionalComponents[n].render()):e.logger.error("Unable to create Additional Component '"+n+"'; No target specified.")})}});e.augment("Controller",t,!1),e.events.on("app:init",function(e){e.controller.setElement(e.$rootEl)},e.controller).on("app:start",function(e){e.controller.loadAdditionalComponents(e.config.additionalComponents)})}(SUGAR.App),function(e){var t;e.augment("routing",{beforeRoute:function(t,n){return this.triggerBefore("route",{route:t,args:n})?_.indexOf(e.config.unsecureRoutes,t)>=0?!0:e.api.isAuthenticated()?e.isSynced?!0:(Backbone.history.stop(),e.sync(),!1):(e.router.login(),!1):!1},after:function(e,t){},setRoutes:function(e){t=e},start:function(){var n={};t&&(n.customRoutes=t),e.augment("router",new e.Router(n),!1),e.events.trigger("router:start",e.router),e.router.start()}}),_.extend(e.routing,e.beforeEvent),e.Router=Backbone.Router.extend({initialize:function(e){e=e||{},e.customRoutes&&(this.customRoutes=e.customRoutes,this._bindCustomRoutes())},_bindCustomRoutes:function(){if(!this.customRoutes)return;this.customRoutes.reverse(),_.each(this.customRoutes,function(e){this.route(e.route,e.name,e.callback)},this)},_routeHandler:function(t){var n=Array.prototype.slice.call(arguments,1),r=t.route;e.routing.beforeRoute(r,n)&&(t.apply(this,n),e.routing.after(r,n))},_moduleExists:function(t){return t&&_.isUndefined(e.metadata.getModule(t))?(e.error.handleHttpError({status:404}),!1):!0},route:function(e,t,n){n||(n=this[t]),n.route=t,n=_.wrap(n,this._routeHandler),Backbone.Router.prototype.route.call(this,e,t,n)},goBack:function(){e.logger.debug("Navigating back..."),window.history.back()},go:function(e){window.history.go(e)},start:function(){return e.logger.info("Router Started"),Backbone.history.stop(),Backbone.history.start()},refresh:function(){Backbone.history.loadUrl(Backbone.history.fragment)},buildRoute:function(t,n,r){var i;if(e.utils&&_.isFunction(e.utils.customBuildRoute)){i=e.utils.customBuildRoute.apply(this,arguments);if(!_.isEmpty(i))return i}return t?(i=_.isString(t)?t:t.get("module"),n&&(i+="/"+n),r&&(i+="/"+r)):i=r,i},index:function(){e.logger.debug("Route changed to index"),e.config.defaultModule?this.navigate(e.config.defaultModule,{trigger:!0}):e.acl.hasAccess("read","Home")&&this.navigate("Home",{trigger:!0})},list:function(t){if(!this._moduleExists(t))return;e.logger.debug("Route changed to list of "+t),e.controller.loadView({module:t,layout:"records"})},layout:function(t,n){if(!this._moduleExists(t))return;e.logger.debug("Route changed to layout: "+n+" for "+t),e.controller.loadView({module:t,layout:n})},create:function(t){if(!this._moduleExists(t))return;e.logger.debug("Route changed: create "+t),e.controller.loadView({module:t,create:!0,layout:"edit"})},login:function(){e.logger.debug("Logging in"),e.controller.loadView({module:"Login",layout:"login",create:!0}),e.events.trigger("router:reauth:load"),e.config.externalLogin&&e.api.ping(null,{success:function(){e.events.trigger("router:reauth:success"),e.router.refresh()},error:function(){e.alert.show("needs_login_error",{level:"error",messages:e.lang.getAppString("LBL_PORTAL_INVALID_CREDS_TITLE"),title:e.lang.get("LBL_PORTAL_INVALID_CREDS_TITLE")})}})},logout:function(t){t=t==="1",e.logger.debug("Logging out: "+t),e.logout({complete:function(){e.router.navigate("#"),e.config.externalLogin?e.controller.loadView({module:"Login",layout:"logout",skipFetch:!0,create:!0}):e.router.login()},success:function(t,n){e.events.trigger("app:logout:success",t)}},t)},record:function(t,n,r,i){if(!this._moduleExists(t))return;var s=e.controller.context.get("collection"),o=e.controller.context.get("listCollection"),u={module:t,layout:i||"record",action:r||"detail"};n!=="create"?_.extend(u,{modelId:n}):(_.extend(u,{create:!0}),u.layout="create"),s&&s.module===t&&s.get(n)&&(u.listCollection=s),o&&o.module===t&&o.get(n)&&(u.listCollection=o),e.controller.loadView(u)},redirect:function(e,t){this.navigate(e,_.extend({trigger:!0,replace:!0},t))}})}(SUGAR.App),function(e){e.augment("lang",{direction:"ltr",get:function(e,t,n){var r=this.getModString(e,t,n)||this.getAppString(e,n)||e;return r},getModString:function(e,t,n){var r;return _.isArray(t)?_.find(t,function(t){return r=this._get("mod_strings",e,t,n),!_.isEmpty(r)},this):r=this._get("mod_strings",e,t,n),r},getAppString:function(e,t){return this._get("app_strings",e,null,t)},getAppListStrings:function(e){var t=this._get("app_list_strings",e)||{};if(_.isArray(t)){var n={};_.each(t,function(e){_.isString(e)?n[e]=e:_.isArray(e)&&e.length==2&&(n[e[0]]=e[1])}),t=n}return t},getModuleName:function(e,t){t=t||{};var n=!t.plural&&this.getModString("LBL_MODULE_NAME_SINGULAR",e)||this.getModString("LBL_MODULE_NAME",e);return!n&&!_.isUndefined(t.defaultValue)&&(n=this.get(t.defaultValue)),n||e},getAppListKeys:function(e){var t=[],n=this._get("app_list_strings",e)||{};return _.isArray(n)?_.each(n,function(e){e.length==2&&t.push(e[0])}):_.isObject(n)&&(t=_.keys[n]),t},_get:function(t,n,r,i){var s=e.metadata.getStrings(t);s=r?s[r]:s;var o=s?this._sanitize(s[n]):null;return o&&!_.isUndefined(i)&&_.isString(o)&&o.indexOf("{{")>-1&&(n="lang."+(r?n+"."+r:n),o=Handlebars.templates[n]?Handlebars.templates[n](i):e.template.compile(n,o)(i)),o},_sanitize:function(e){return _.isString(e)&&e.lastIndexOf(":")==e.length-1?e.substring(0,e.length-1):e},getLanguage:function(){return this._currentLanguage},setLanguage:function(t,n,r){var i=this;r=r||{},_.each(Handlebars.templates,function(e,t){t.indexOf("lang.")==0&&delete Handlebars.templates[t]});if(r.noSync===!0){this.updateLanguage(t);return}e.sync({callback:function(s){var o=!1;s||(i.updateLanguage(t),o=!e.api.isAuthenticated()&&!r.noUserUpdate,e.cache.set("langHasChanged",o)),n&&n(s)},getPublic:!e.api.isAuthenticated(),noUserUpdate:r.noUserUpdate||!1,language:t,forceRefresh:!0,metadataTypes:["labels"]})},updateLanguage:function(t){e.cache.set("lang",t),e.user.setPreference("language",t),e.trigger("app:locale:change"),this.setCurrentLanguage(t)},setDefaultLanguage:function(e){this._defaultLanguage=e},getDefaultLanguage:function(){return this._defaultLanguage},setCurrentLanguage:function(e){this._currentLanguage=e,this.setDirection(e)},setDirection:function(t){var n=["he_IL","ar_SA"],r=_.contains(n,t),i=this.direction;this.direction=r?"rtl":"ltr",this.direction!==i&&e.trigger("lang:direction:change")}})}(SUGAR.App),function(app){function _setHash(e,t){var n=t?"public:":"";app.cache.set(_keyPrefix+n+"hash",e._hash)}function _cacheMeta(e){app.cache.set(_keyPrefix+"data",e)}function _getCachedMeta(){return app.cache.get(_keyPrefix+"data")}function _injectLabels(e,t){_.each(t,function(n,r){r!=="_hash"&&(e[r]=t[r])}),delete e.labels}function _fetchLabels(e,t){var n,r,i,s=app.user.getLanguage();n=e.ordered_labels||e.labels,app.lang.setDefaultLanguage(n["default"]),t.language&&n[t.language]?r=t.language:n[s]?r=s:(r=app.lang.getDefaultLanguage(),app.user.id&&app.user.updateLanguage(r)),app.lang.setCurrentLanguage(r),i=app.utils.buildUrl(n[r]),app.api.call("read",i,null,{success:function(e){try{e=_.isString(e)?JSON.parse(e):e}catch(n){app.logger.fatal("Failed to parse labels data: "+n),t.error({code:"sync_failed",label:"ERR_SYNC_FAILED"});return}t.success(e)},error:function(e){e.code="sync_failed",e.label="ERR_SYNC_FAILED",t.error(e)}})}function _initCustomComponents(e,t){var n=this,r=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each({layout:"layout",view:"view",fieldTemplate:"field",data:"data"},function(i,s){n._metaTypeIsSeparatedByPlatform(e,s,r)&&_.each(r,function(r){var o=e[s+"s"][r];n._sortAndDeclareComponents(o,i,t,r)}),_.each(e[s+"s"],function(e,n){i==="view"&&e.templates&&_.each(e.templates,function(e,r){var i=n===r;r=i?r:n+"."+r,app.template.setView(r,t,e,!0)}),i==="layout"&&e.templates&&_.each(e.templates,function(e,r){r=n===r?r:n+"."+r,app.template.setLayout(r,t,e,!0)}),i==="field"&&e.templates&&_.each(e.templates,function(e,r){app.template.setField(n,r,t,e,!0)})})},this)}var _keyPrefix="meta:",_metadata={},_mdLoaded={},_syncing=!1;app.augment("metadata",{fieldTypeMap:{varchar:"text",datetime:"datetimecombo",multienum:"enum",text:"textarea",decimal:"float"},_patchMetadata:function(e,t){return!t||t._patched===!0?t:(_.each(t.views,function(n){n.meta&&_.each(n.meta.panels,function(n){n.fields=this._patchFields(e,t,n.fields)},this)},this),t._patched=!0,t)},_patchFields:function(e,t,n){var r=this;return _.each(n,function(i,s){var o=_.isString(i)?i:i.name,u=t.fields[o];if(i.fields){i.fields=r._patchFields(e,t,i.fields);return}_.isEmpty(u)?i===""&&(i={view:"detail"},n[s]=i):(_.isString(i)&&(i={name:i}),_.isObject(i.displayParams)&&(_.extend(i,i.displayParams),delete i.displayParams),i.type=i.type||u.custom_type||u.type||"base",i.type=r.fieldTypeMap[i.type]||i.type,i.label=i.label||u.vname||i.name,n[s]=i)},this),n},_sortControllers:function(type,components,module){var updated={},nameMap={},entries={},updateWeights=function(e){var t=e.controller;_.isObject(t)&&_.isString(t.extendsFrom)&&entries[t.extendsFrom]&&!updated[t.extendsFrom]&&(entries[t.extendsFrom].weight--,updated[t.extendsFrom]=!0,updateWeights(entries[t.extendsFrom]))};return _.each(components,function(entry,name){if(entry.controller){var controller=entry.controller,className=(module||"")+app.utils.capitalizeHyphenated(name)+app.utils.capitalize(type);nameMap[className]=name;if(_.isString(controller))try{controller=eval("["+controller+"][0]")}catch(e){app.logger.error("Failed to eval view controller for "+className+": "+e+":\n"+entry.controller)}entries[className]={type:name,controller:controller,weight:0}}}),_.each(entries,function(e,t){var n=e.controller,r;_.isObject(n)&&_.isString(n.extendsFrom)&&(r="Custom"+n.extendsFrom,r in entries&&t!=r&&(n.extendsFrom=r))}),_.each(entries,function(e){updated={},updateWeights(e)}),_.sortBy(entries,"weight")},_sortAndDeclareComponents:function(e,t,n,r){var i,s=this;if(!_.isUndefined(e)&&e){i=s._sortControllers(t,e,n);if(t==="data"){var o,u;_.each(i,function(e){e.type==="model"?o=e.controller:e.type==="collection"&&(u=e.controller)}),app.data.declareModelClass(n,null,r,o),app.data.declareCollectionClass(n,r,u)}else _.each(i,function(e){app.view.declareComponent(t,e.type,n,e.controller,!0,r)})}},_metaTypeIsSeparatedByPlatform:function(e,t,n){if(!_.isUndefined(e[t+"s"]))for(var r=0;r<n.length;r++)if(!_.isUndefined(e[t+"s"][n[r]])&&_.isUndefined(e[t+"s"][n[r]].controller))return!0;return!1},_declareClasses:function(e){var t=this,n=app.config.platform!=="base"?["base",app.config.platform]:["base"];_.each(["field","view","layout","data"],function(r){var i;t._metaTypeIsSeparatedByPlatform(e,r,n)&&_.each(n,function(n){i=e[r+"s"][n],t._sortAndDeclareComponents(i,r,null,n)},this)},this),_.each(e.modules,function(e,t){_initCustomComponents.call(this,e,t)},this)},getModules:function(){return _metadata.modules},getHiddenSubpanels:function(){return _metadata.hidden_subpanels},getModule:function(e,t){var n=this.getModules();return n&&(n=n[e]),n&&t&&(n=n[t]),n},getRelationship:function(e){return _metadata.relationships?_metadata.relationships[e]:null},getField:function(e){var t=_metadata.fields?_metadata.fields[e]||_metadata.base:null;return t?app.metadata.copy(t,{field:e}):t},getView:function(e,t){var n=e?this.getModule(e,"views"):_metadata.views;return t&&(n&&n[t]&&!_.isUndefined(n[t].meta)?n=n[t].meta:_metadata.views&&_metadata.views[t]&&!_.isUndefined(_metadata.views[t].meta)?n=_metadata.views[t].meta:n=null),n?app.metadata.copy(n,{module:e,view:t}):n},getLayout:function(e,t){var n=this.getModule(e,"layouts");return t&&(n&&n[t]?n=n[t].meta:_metadata.layouts&&_metadata.layouts[t]?n=_metadata.layouts[t].meta:n=null),n?app.metadata.copy(n,{module:e,layout:t}):n},getModuleNames:function(e){var t=["enabled","!enabled","visible","!visible","display_tab","!display_tab","show_subpanels","!show_subpanels","quick_create","!quick_create"];arguments=Array.prototype.slice.call(arguments);if(arguments.length>=1&&!_.isObject(arguments[0])){app.logger.warn("getModuleNames no longer accepts visible and access params.");var n=_.clone(arguments);e={},n[0]&&(e.filter="display_tab"),e.access=n[1]}e=e||{};var r=[],i=_.isUndefined(_metadata.modules_info);if(i)return r=_.clone(app.user.get("module_list")),e.access&&(r=_.filter(r,function(t){return app.acl.hasAccess(e.access,t)})),r||[];var s,o=!1;return e.filter&&(_.isArray(e.filter)||(e.filter=[e.filter]),s=[],_.each(e.filter,function(e){e&&_.indexOf(t,e)>-1?(s.push(e),o=e==="display_tab"):e&&app.logger.warn("Can't filter getModuleNames by "+e)}),_.isEmpty(s)&&(s=undefined)),r=_.chain(_metadata.modules_info).keys().without("_hash").value(),s&&_.each(s,function(t){var n=t.charAt(0)==="!";if(n){var i=app.metadata.getModuleNames({filter:t.substring(1),access:e.access});r=_.difference(r,i)}else r=_.filter(r,function(e){return _metadata.modules_info[e][t]})}),_.isEmpty(app.user.get("module_list"))||(o?r=_.intersection(app.user.get("module_list"),r):s||(r=_.union(app.user.get("module_list"),r))),e.access&&(r=_.filter(r,function(t){return app.acl.hasAccess(e.access,t)})),r},getStrings:function(e){return _metadata[e]||{}},getFullModuleList:function(){return _metadata.full_module_list||{}},getConfig:function(){return _metadata.config||{}},getBaseCurrencyId:function(){return"-99"},getCurrency:function(e){return this.getCurrencies()[e]},getCurrencies:function(){return _metadata.currencies||{}},getLogoUrl:function(){return _metadata.logo_url},getServerInfo:function(){return _metadata.server_info||{}},getModuleTabMap:function(){return _metadata.module_tab_map||{}},getTabMappedModule:function(e){var t=this.getModuleTabMap();return t[e]||e},getFilterOperators:function(e){var t=_metadata.filters&&_metadata.filters.operators&&_metadata.filters.operators.meta,n=e&&this.getModule(e,"filters"),r=n&&n.operators&&n.operators.meta;return r||t||{}},getEditableDropdownFilter:function(e){var t=_metadata.editable_dropdown_filters;return t&&t[e]?app.metadata.copy(t[e]):{}},copy:function(e,t){return app.utils.deepCopy(e)},set:function(e,t,n){_.each(e.modules,function(e,t){this._patchMetadata(t,e)},this),this._declareClasses(e),app.config=_.extend(app.config||{},e.config),app.template.set(e,e._hash&&e._hash!=this.getHash(t)),_.isEmpty(e._hash)||_setHash(e,t);if(!n){var r=e._override_values||[];delete e._override_values,_.each(e,function(e,t){_metadata[t]=_.isObject(e)&&!_.contains(r,t)?_.extend(_metadata[t]||{},e):e})}else _metadata=e;app.config.cacheMeta&&!t&&_cacheMeta(_metadata),app.config.env!="prod"&&(this._dev_data=_metadata)},getHash:function(e){var t=e?_keyPrefix+"public:hash":_keyPrefix+"hash";return app.cache.get(t)||_metadata._hash||""},sync:function(e,t){_syncing=!0,t=t||{},t.params=t.params||{};var n=this,r=t.metadataTypes||(t.getPublic?app.config.publicMetadataTypes:app.config.metadataTypes)||[],i=function(t){app.logger.debug("Failed fetching metadata"),app.error.handleHttpError(t),e.call(n,t)},s=e;e=function(e){_syncing=!1,_.isFunction(s)&&s(e)},app.api.getMetadata(n.getHash(t.getPublic),r,[],{success:function(s){var o;t=t||{};if(!_.isEmpty(s)){app.logger.debug("Updating metadata");if(_mdLoaded[t.getPublic?"public:md"
:"md"]&&n.getHash(t.getPublic)==s._hash&&!t.forceRefresh)return app.logger.debug("Skipping update as metadata hash matches"),e.call(n);if(_.isEmpty(r)||_.include(r,"server_info")&&!t.getPublic){o=app.isServerCompatible(s.server_info);if(o!==!0)return e(o)}_mdLoaded[t.getPublic?"public:md":"md"]=!0,s.jssource?n._loadJSSource(s,t,e,i,n):s.labels||s.ordered_labels?_fetchLabels(s,{language:t.language,success:function(r){_injectLabels(s,r),n.set(s,t.getPublic),e.call(n)},error:i}):e.call(n)}else e.call(n,{code:"sync_failed",label:"ERR_SYNC_FAILED"})},error:i},t)},isSyncing:function(){return _syncing},_loadJSSource:function(e,t,n,r,i){var s,o=this._checkJSSourceUpdated(e,!!t.getPublic);if(o==="reload")return app.utils.hardRefresh();o&&(SUGAR.jssource=!1,s=document.createElement("script"),s.src=app.utils.buildUrl(e.jssource),document.head.appendChild(s)),async.parallel([function(e){o?app.utils.doWhen("SUGAR.jssource",function(){i._declareClasses(SUGAR.jssource),e()}):e()},function(n){_fetchLabels(e,{language:t.language,success:function(r){_injectLabels(e,r),i.set(e,t.getPublic),n()},error:function(){r.apply(i,arguments),n()}})}],function(e,t){n&&n.call(i)})},_checkJSSourceUpdated:function(e,t){return t?this._publicJSSourceFile?this._publicJSSourceFile!=e.jssource?"reload":!1:(this._publicJSSourceFile=e.jssource,!0):e.jssource_public&&this._publicJSSourceFile&&e.jssource_public!=this._publicJSSourceFile?(app.utils.hardRefresh(),"reload"):this._jsSourceFile?this._jsSourceFile!=e.jssource?"reload":!1:!0},init:function(){var e=this,t=function(){!_syncing&&(e.getHash()!=_metadata._hash&&_mdLoaded.md||app.api.getUserprefHash()&&app.user.get("_hash")&&app.api.getUserprefHash()!=app.user.get("_hash"))&&(_syncing=!0,window.clearInterval(e._validateMDInterval),this._validateMDInterval=null,window.setTimeout(function(){_mdLoaded.md=!1,app.sync({getPublic:!app.api.isAuthenticated(),callback:function(){e._validateMDInterval=window.setInterval(t,100)}})},500))};if(app.config.cacheMeta){var n=_getCachedMeta();n&&this.set(n,!1)}this._validateMDInterval=window.setInterval(t,100),app.events.on("cache:clean",function(e){e([_keyPrefix+"public:hash",_keyPrefix+"hash",_keyPrefix+"data"])})},clearCache:function(){app.cache.cut(_keyPrefix+"public:hash"),app.cache.cut(_keyPrefix+"hash"),app.cache.cut(_keyPrefix+"data")},reset:function(){_metadata={},this.clearCache()}},!1)}(SUGAR.App),function(e){e.augment("acl",{_accessToAny:{},action2permission:{view:"read",readonly:"read",edit:"write",detail:"read",list:"read",disabled:"write"},init:function(e){e&&e.events.on("app:sync:complete",this.clearCache,this)},clearCache:function(){this._accessToAny={}},_hasAccess:function(e,t){var n;return t.access==="no"?n="no":n=t[e],n!=="no"},_hasAccessToField:function(e,t,n){var r;return e=this.action2permission[e]||e,t.fields[n]&&t.fields[n][e]&&(r=t.fields[n][e]),r!=="no"},hasAccess:function(t,n,r,i,s){var o=e.user.getAcls()[n],u=!0;if(o||s){o=o||{};if(s){o=e.utils.deepCopy(o),o.fields=o.fields||{},_.extend(o.fields,s.fields);var a=o.fields;_.extend(o,s),o.fields=a}u=this._hasAccess(t,o);if(i&&o.fields&&u){u=this._hasAccessToField(t,o,i);var f=e.metadata.getModule(n),l=f&&f.fields?f.fields[i]:null;u&&l&&l.group&&(u=this._hasAccessToField(t,o,l.group))}}return u},hasAccessToModel:function(e,t,n){var r,i,s,o,u=!0;return t&&(r=t.id,i=t.module,s=t.original_assigned_user_id||t.get("assigned_user_id"),o=t.get("_acl")||{fields:{}}),e=="edit"&&!r&&(e="create"),u===!0&&(u=this.hasAccess(e,i,s,n,o)),u},hasAccessToAny:function(t){return _.isUndefined(this._accessToAny[t])&&(this._accessToAny[t]=_.some(e.user.getAcls(),function(e,n){return this.hasAccess(t,n)},this)),this._accessToAny[t]}},!0)}(SUGAR.App),function(e){var t=Backbone.Model.extend({load:function(t){e.api.me("read",null,null,{success:function(n){if(n&&n.current_user){n.current_user._hash&&e.cache.set("userpref:hash",n.current_user._hash),e.user.set(n.current_user);var r=e.user.getPreference("language");e.lang.getLanguage()!=r&&e.lang.setLanguage(r,null,{noUserUpdate:!0,noSync:e.isSynced})}t&&t()},error:function(n){e.error.handleHttpError(n),t&&t(n)}})},loadLocale:function(t){e.api.call("read",e.api.buildURL("locale"),null,{success:function(n){n&&n._hash&&(e.cache.set("userpref:hash",n._hash),e.user.set({_hash:n._hash})),t&&t(n)},error:function(n){e.error.handleHttpError(n),t&&t(n)}})},getLanguage:function(){return e.user.getPreference("language")||e.cache.get("lang")},updateLanguage:function(t,n){var r=function(r){r||e.lang.updateLanguage(t),n&&n(r)};this.update("update",{preferred_language:t},r)},updateProfile:function(e,t){var n=function(e){t&&t(e)};this.update("update",e,n)},updatePreferences:function(t,n){var r=this;e.api.isAuthenticated()?e.api.call("update",e.api.buildURL("me/preferences"),t,{success:function(i){i._hash&&(e.cache.set("userpref:hash",i._hash),e.user.set({_hash:i._hash})),_.each(t,function(e,t){i[t]&&r.setPreference(t,i[t])}),n&&n()},error:function(t){e.error.handleHttpError(t),n&&n(t)}}):n&&n()},update:function(t,n,r){e.api.isAuthenticated()?e.api.me(t,n,null,{success:function(t){t.current_user&&(t.current_user._hash&&e.cache.set("userpref:hash",t.current_user._hash),e.user.set(t.current_user)),r&&r()},error:function(t){e.error.handleHttpError(t),r&&r(t)}}):r()},getAcls:function(){return e.user.get("acl")||{}},getPreference:function(t){var n=e.user.get("preferences")||{};return n[t]},setPreference:function(t,n){var r=e.user.get("preferences")||{};return r[t]=n,e.user.set("preferences",r)},getCurrency:function(){var t=e.user.get("preferences"),n={};return t&&(n.currency_id=t.currency_id,n.currency_iso=t.currency_iso,n.currency_name=t.currency_name,n.currency_rate=t.currency_rate,n.currency_show_preferred=t.currency_show_preferred,n.currency_symbol=t.currency_symbol),n},lastState:function(){var t=":",n="last-state",r={},i=[],s=function(r){var i=r.split(t),s=[e.user.id,n];return s=s.concat(i),s.join(t)},o=function(e){var t;return e.meta&&e.meta.last_state&&(t=e.meta.last_state.id),t};return{get:function(t){var n,r;return _.isUndefined(t)||(r=s(t),n=e.cache.get(r)||this.defaults(t)),n},set:function(t,n){if(!_.isUndefined(t)&&!_.isUndefined(n)){var r=s(t);e.cache.set(r,n)}},preserve:function(e){_.isUndefined(e)||i.push(e)},key:function(e,t){var n=o(t);return this.buildKey(e,n,t.module)},buildKey:function(e,n,r){var i,s=[];return n&&(r&&s.push(r),s.push(n,e),i=s.join(t)),i},defaults:function(e){return r[e]},register:function(e){var t=o(e);t&&_.each(e.meta.last_state.defaults,function(t,n){r[this.key(n,e)]=t},this)},remove:function(t){var n;_.isUndefined(t)||(n=s(t),e.cache.cut(n))},_getPreservedKeys:function(){var e=[];return _.each(i,function(t){e.push(s(t))}),e}}}()});e.events.on("app:logout",function(t){t===!0&&e.user.clear({silent:!0})}),e.events.on("cache:clean",function(t){t(e.user.lastState._getPreservedKeys())}),e.augment("user",new t,!1)}(SUGAR.App),function(e){var t={plugins:{view:{},field:{},layout:{},model:{},collection:{}},_get:function(e,t){if(this.plugins[t]&&this.plugins[t][e])return this.plugins[t][e]},attach:function(e,t){_.each(e.plugins,function(n,r){var i=null;if(_.isObject(n)){var s=_.keys(n)[0];i=n[s],n=s}var o=this._get(n,t);if(o&&!this._isPluginDisabled(e,n)){var u=_.extend({},_.isFunction(e.events)?e.events():e.events,o.events);_.extend(e,o),i&&(_.extend(e,i),i.events&&_.extend(u,i.events)),e.events=u,_.isFunction(o.onAttach)&&o.onAttach.call(e,e,o)}},this)},detach:function(e,t){_.each(e.plugins,function(n){var r=this._get(n,t);r&&_.isFunction(r.onDetach)&&r.onDetach.call(e,e,r)},this)},_isPluginDisabled:function(e,t){return!!_.find(e.disabledPlugins,function(e){return e===t})},register:function(e,t,n){_.isArray(t)||(t=[t]),_.each(t,function(t){this.plugins[t]=this.plugins[t]||{},this.plugins[t][e]=n},this)}};e.augment("plugins",t,!1)}(SUGAR.App),function(e){e.augment("logger",{levels:{TRACE:{value:1,name:"TRACE"},DEBUG:{value:2,name:"DEBUG"},INFO:{value:3,name:"INFO"},WARN:{value:4,name:"WARN"},ERROR:{value:5,name:"ERROR"},FATAL:{value:6,name:"FATAL"}},ConsoleWriter:{write:function(t,n){window.console||(window.console={}),window.console.log||(window.console.log=function(){}),t.value<=e.logger.levels.INFO.value?console.log(n):t.value==e.logger.levels.WARN.value?console.warn(n):console.error(n)}},ServerWriter:{write:function(t,n){if(t.value<e.logger.levels.WARN.value)return;if(!e.api.isAuthenticated())return;var r=e.config.logger&&e.config.logger.writeToServer||!1;if(!r||!n.trim().length)return;var i=e.api.buildURL(undefined,"logger"),s={level:t.name.toLowerCase(),message:n};e.api.call("create",i,s,{success:function(e){if(!e.status)throw"Failed to write log message {"+n+"} onto server"},error:function(e){throw e}})}},SimpleFormatter:{format:function(e,t,n){var r=n.getUTCFullYear()+"-"+(n.getUTCMonth()+1)+"-"+n.getUTCDate()+" "+n.getUTCHours()+":"+n.getUTCMinutes()+":"+n.getUTCSeconds();return e.name+"["+r+"]: "+t}},trace:function(e){this.log(this.levels.TRACE,e)},debug:function(e){this.log(this.levels.DEBUG,e)},info:function(e){this.log(this.levels.INFO,e)},warn:function(e){this.log(this.levels.WARN,e)},error:function(e){this.log(this.levels.ERROR,e)},fatal:function(e){this.log(this.levels.FATAL,e)},getLevel:function(){var t=e.config.logLevel;return t?this.levels[e.config.logLevel]:(t=e.config.logger&&e.config.logger.level,t=t&&this.levels[t.toUpperCase()]||this.levels.ERROR,t)},log:function(t,n){try{var r=this.getLevel();if(t.value<r.value)return;n=n||"<none>",_.isFunction(n)&&(n=n.call(this));if(_.isObject(n))try{n=JSON.stringify(n)}catch(i){n=n.toString()}var s=e.config.logger,o=this[e.config.logFormatter];o||(o=s&&this[s.formatter]||this.SimpleFormatter),n=o.format(t,n,new Date);var u=this[e.config.logWriter];u||(u=s&&this[s.consoleWriter]||this.ConsoleWriter);var a=s&&this[s.serverWriter]||this.ServerWriter;u.write(t,n),a.write(t,n)}catch(i){console.log("Failed to log message {"+n+"} due to exception: "+i)}}},!1)}(SUGAR.App),function(e){function t(e,t,n,r){if(_.isUndefined(t))return;_.isUndefined(e[n])&&(e[n]={}),e[n][r]=t}Backbone.Model.prototype.doValidate=function(e,t){t(this.isValid())},e.augment("Bean",Backbone.Model.extend({constructor:function(t,n){e.plugins.attach(this,"model"),Backbone.Model.prototype.constructor.call(this,t,n)},initialize:function(t){Backbone.Model.prototype.initialize.call(this,t),this.setSyncedAttributes(t),this.on("sync",function(){this.setSyncedAttributes(this.attributes)},this),this._relatedCollections=null,this.isNew()&&this._defaults&&_.each(this._defaults,function(e,t){this.has(t)||this.set(t,e,{silent:!0})},this),this.fields&&(this.fields=e.metadata.copy(this.fields,{bean:this})),this.addValidationTask("sidecar",_.bind(this._doValidate,this))},dispose:function(){e.plugins.detach(this,"model")},_setRelatedCollection:function(e,t){this._relatedCollections||(this._relatedCollections={}),this._relatedCollections[e]=t},getRelatedCollection:function(t){return this._relatedCollections&&this._relatedCollections[t]?this._relatedCollections[t]:e.data.createRelatedCollection(this,t)},doValidate:function(e,t){var n=this;e=e||this.fields,this.trigger("validation:start"),async.waterfall(_.flatten([function(t){t(null,e,{})},_.sortBy(n._validationTasks)]),function(e,r,i){if(!e){var s=_.isEmpty(i);s&&n.trigger("validation:success"),n.trigger("validation:complete",n._processValidationErrors(i)),_.isFunction(t)&&t(s)}});return},_doValidate:function(n,r,i){var s;_.each(n,function(n,i){_.isString(n)&&(i=n,n=this.fields[i]),s=this.get(i),n&&(t(r,e.validation.requiredValidator(n,n.name,this,s),i,"required"),(s||s===0)&&_.each(e.validation.validators,function(e,o){t(r,e(n,s,this),i,o)},this))},this),i(null,n,r)},addValidationTask:function(e,t){this._validationTasks=this._validationTasks||{},this._validationTasks[e]=t},removeValidationTask:function(e){this._validationTasks&&(this._validationTasks=_.omit(this._validationTasks,e))},_processValidationErrors:function(t){var n=!0;return _.isEmpty(t)||(e.error.handleValidationError(this,t),_.each(t,function(e,t){this.trigger("error:validation:"+t,e)},this),this.trigger("error:validation",t),n=!1),n},save:function(e,t){var n=!0,r=this;if(t&&t.fieldsToValidate){this.doValidate(t.fieldsToValidate,function(n){n&&Backbone.Model.prototype.save.call(r,e,t)});return}return Backbone.Model.prototype.save.call(this,e,t)},canHaveAttachments:function(){return _.has(this.fields,"attachment_list")},getFiles:function(t,n){return n=n||{},n.passOAuthToken=!1,e.api.file("read",{module:this.module,id:this.id},null,t,n)},copy:function(t,n,r){var i={},s=e.metadata.getModule(this.module).fields;n=n||_.pluck(s,"name"),_.each(n,function(n){var r=s[n],o;if(!r||r.duplicate_on_record_copy==="no")return;o=r.duplicate_on_record_copy==="always"||n!=="id"&&r.type!=="link"&&!r.auto_increment;if(o&&t.has(n)){var u=t.get(n);_.isObject(u)&&(u=e.utils.deepCopy(u)),i[n]=u}}),this.set(i,r),this.isCopied=!0},isCopy:function(){return this.isCopied===!0},uploadFile:function(t,n,r,i){return r=r||{},i=i||{},e.api.file("create",{id:i.temp!==!0?this.id:"temp",module:this.module,field:t},n,r,i)},favorite:function(e,t){return t=t||{},t.favorite=!0,this.save({my_favorite:!!e},t)},follow:function(e,t){return t=t||{},e=e||!1,t.following=!0,this.save({following:e},t)},isFavorite:function(){var e=this.get("my_favorite");return e==="1"||e===!0},toJSON:function(e){var t=e&&e.fields?e.fields:_.keys(this.attributes),n={};return _.each(t,function(t){var r=this.get(t);_.isObject(r)&&_.isFunction(r.toJSON)&&(r=r.toJSON(e)),n[t]=r},this),n},toString:function(){return"bean:"+this.module+"/"+(this.id?this.id:"<no-id>")},revertAttributes:function(t){t=t||{};var n=this.changedAttributes(this.getSyncedAttributes());this.set(e.utils.deepCopy(n)||{},t),t.silent||this.trigger("attributes:revert")},setSyncedAttributes:function(t){this._syncedAttributes=t?e.utils.deepCopy(t):{}},getSyncedAttributes:function(){return this._syncedAttributes},setDefaultAttributes:function(t){e.logger.warn("Data.Bean.setDefaultAttributes is deprecated. Please update your code to use Data.Bean.setDefault"),this._defaults={},this.setDefault(t)},setDefaultAttribute:function(t,n){e.logger.warn("Data.Bean.setDefaultAttribute is deprecated. Please update your code to use Data.Bean.setDefault"),this.setDefault(t,n)},removeDefaultAttribute:function(t){e.logger.warn("Data.Bean.removeDefaultAttribute is deprecated. We consider it as a bad practice so the method will be removed in 7.8. Please update your code to stop using it."),this._defaults&&(this.hasOwnProperty("_defaults")||(this._defaults=_.clone(this._defaults)),delete this._defaults[t])},getDefaultAttribute:function(t){return e.logger.warn("Data.Bean.getDefaultAttribute is deprecated. Please update your code to use Data.Bean.getDefault"),this.getDefault(t)},getDefaultAttributes:function(){return e.logger.warn("Data.Bean.getDefaultAttributes is deprecated. Please update your code to use Data.Bean.getDefault"),this.getDefault()},getDefault:function(e){var t=_.clone(this._defaults)||{};return _.isUndefined(e)?t:t[e]},setDefault:function(e,t){var n;return _.isObject(e)?n=e:(n={})[e]=t,this._defaults=_.extend({},this._defaults,n),this.attributes=_.defaults(this.attributes,n),this}}),!1)}(SUGAR.App),function(e){e.augment("BeanCollection",Backbone.Collection.extend({constructor:function(t,n){e.plugins.attach(this,"collection"),n&&n.link&&(this.link=n.link,delete n.link),Backbone.Collection.prototype.constructor.call(this,t,n)},initialize:function(t,n){this._initOptions=e.utils.deepCopy(n),this._activeFetchRequest=null,this.on("data:sync:complete",function(){this._activeFetchRequest=null},this),Backbone.Collection.prototype.initialize.call(this,t,n)},dispose:function(){e.plugins.detach(this,"collection")},_prepareModel:function(e,t){var n=e._search;return delete e._search,e=Backbone.Collection.prototype._prepareModel.call(this,e,t),e&&!e.link&&(e.link=this.link),n&&(e.searchInfo=n),e},fetch:function(e){return e=_.extend({},this.options,e),this.abortFetchRequest(),e.fields=this.fields=e.fields||this.fields||null,e.myItems=_.isUndefined(e.myItems)?this.myItems:e.myItems,e.favorites=_.isUndefined(e.favorites)?this.favorites:e.favorites,e.query=_.isUndefined(e.query)?this.query:e.query,this.options=e,this._activeFetchRequest=Backbone.Collection.prototype.fetch.call(this,e),this._activeFetchRequest},getFetchRequest:function(){return this._activeFetchRequest},abortFetchRequest:function(){var t=this.getFetchRequest();t&&e.api.abortRequest(t.uid)},resetPagination:function(){var e={offset:0,next_offset:0,page:1},t=_.keys(e);this.resetOptions(t),_.each(t,function(t){this.options&&this.options[t]?this[t]=this.options[t]:this[t]=e[t]},this)},resetOptions:function(e){_.isEmpty(this._initOptions)?this.options={}:e?(this.options=this.options||{},_.each(e,function(e){_.isUndefined(this._initOptions[e])?delete this.options[e]:this.options[e]=this._initOptions[e]},this)):this.options=this._initOptions},paginate:function(t){t=t||{};var n=t.limit||e.config.maxQueryResult;t.page=t.page||1,t.page--,n&&(t.offset=this.offset+t.page*n),t.add&&(t=_.extend({update:!0,remove:!1},t)),this.fetch(t)},hasAtLeast:function(t,n){n=n||{};var r="read";n.fields=["id"],delete n.view,n.silent=!0,n.success=_.wrap(n.success,_.bind(function(e,n){var r=n.records.length,i=r>=t,s={length:r,hasMore:n.next_offset!==-1};_.isFunction(e)&&e(i,s),this.reset(null,{silent:!0})},this));var i=this.module,s=null,o="records";n.filter=n.filterDef||this.filterDef,this.link&&(s={id:this.link.bean.id,link:this.link.name},i=this.link.bean.module,o="relationships");var u=_.pick(n,"success","complete","error");return n=_.omit(n,"success","complete","error"),n=e.data.parseOptionsForSync(r,this,n),e.api[o](r,i,s,n.params,u,n.apiOptions)},getPageNumber:function(t){var n=1,r=e.config.maxQueryResult;return t&&(r=t.limit||r),this.offset&&r&&(n=Math.ceil(this.offset/r)),n},toString:function(){return"coll:"+(this.link?this.link.bean.module+"/"+this.link.bean.id+"/":"")+this.module+"-"+this.length},getNext:function(e,t){var n=-1,r=null,i=this;this.hasNextModel(e)&&(n=this.getModelIndex(e),n+1>=this.length?this.paginate({add:!0,success:function(e,r,s){t.apply(i,[i.at(n+1),"next"])}}):t.apply(i,[i.at(n+1),"next"]))},getPrev:function(e,t){var n=-1,r=null,i=this;this.hasPreviousModel(e)&&(n=this.getModelIndex(e),r=this.at(n-1)),t.apply(i,[r,"prev"])},hasNextModel:function(e){var t=this.getModelIndex(e),n=_.isUndefined(this.next_offset)?-1:parseInt(this.next_offset,10);return t>=0&&(this.length>t+1||n!==-1)},hasPreviousModel:function(e){return this.getModelIndex(e)>0},getModelIndex:function(e){return this.indexOf(this.get(e.id))}}),!1)}(SUGAR.App),function(e){e.augment("MixedBeanCollection",e.BeanCollection.extend({_prepareModel:function(t,n){var r=t instanceof e.Bean?t.module:t._module;return this.model=e.data.getBeanClass(r),e.BeanCollection.prototype._prepareModel.call(this,t,n)},fetch:function(t){return t=t||{},t.module_list=this.module_list=t.module_list||this.module_list||e.metadata.getModuleNames({filter:"visible"}),e.BeanCollection.prototype.fetch.call(this,t)},groupByModule:function(){return _.groupBy(this.models,function(e){return e.module})},toString:function(){return"mcoll:"+this.length}}),!1)}(SUGAR.App),function(e){var t={},n={},r=_.extend({beanModel:e.Bean,beanCollection:e.BeanCollection,mixedBeanCollection:e.MixedBeanCollection,init:function(){var t=_.bind(this.sync,this);e.Bean.prototype.sync=t,e.BeanCollection.prototype.sync=t,e.events.register("data:sync:start",this),e.events.register("data:sync:complete",this),e.events.register("data:sync:success",this),e.events.register("data:sync:error",this),e.events.register("data:sync:abort",this)},reset:function(e){this.resetModel(e),this.resetCollection(e)},resetModel:function(e){e?delete t[e]:t={}},resetCollection:function(e){e?delete n[e]:n={}},declareModel:function(t,n,r,i,s){r=r||e.config.platform||"base";var o=this.declareModelClass(t,n,r,i);this.declareCollectionClass(t,r,s)},declareModelClass:function(n,r,i,s){var o=e.utils.capitalize(i);n=n||o+"Model",this.resetModel(n);var u=r?r.fields:{},a=null;_.each(_.values(u),function(e){_.isUndefined(e["default"])||(a===null&&(a={}),a[e.name]=e["default"])});var f={_defaults:a,module:n,fields:u},l=t[o+"Model"]||t.BaseModel||this.beanModel;return s=_.extend(s||{},f),e.utils.extendClass(t,l,n,s,o)},declareCollectionClass:function(r,i,s){var o=e.utils.capitalize(i),u=r||o+"Model",a=t[u];r=r||o+"Collection";if(!a)return;this.resetCollection(r);var f={model:a,module:r,offset:0},l=n[o+"Collection"]||n.BaseCollection||this.beanCollection;return s=_.extend(s||{},f),e.utils.extendClass(n,l,r,s,o)},mergeModel:function(e,n){var r=n?n.fields:{},i=null;_.each(_.values(r),function(e){_.isUndefined(e["default"])||(i===null&&(i={}),i[e.name]=e["default"])});var s={_defaults:i,module:e,fields:r};_.extend(t[e].prototype,s)},getModelClasses:function(){return t},getCollectionClasses:function(){return n},declareModels:function(n){n=n||e.metadata.getModules(),_.each(n,function(e,n){t[n]?this.mergeModel(n,e):this.declareModel(n,e)},this)},getBeanClass:function(e){return t[e]||Backbone.Model},createBean:function(n,r,i){return t[n]?new t[n](r,i):new e.data.beanModel(r,i)},createBeanCollection:function(t,r,i){return n[t]?new n[t](r,i):new e.data.beanCollection(r,i)},createRelatedBean:function(e,t,n,r){var i=this.getRelatedModule(e.module,n);return r=r||{},_.isString(t)?(r.id=t,t=this.createBean(i,r)):_.isNull(t)?t=this.createBean(i,r):t.set(r),t.link={name:n,bean:e,isNew:!0},t},createRelatedCollection:function(e,t,n){var r=this.getRelatedModule(e.module,t),i=this.createBeanCollection(r,n,{link:{name:t,bean:e}});return e._setRelatedCollection(t,i),i},createMixedBeanCollection:function(t){return new e.data.mixedBeanCollection(t)},canHaveMany:function(t,n){var r=e.metadata.getModule(t);if(!r||!r.fields||!r.fields[n])return!1;if(r.fields[n].link_type)return r.fields[n].link_type==="many";var i=r.fields[n].relationship,s=e.metadata.getRelationship(i),o=s.relationship_type.split("-"),u;return r.fields[n].side?u=r.fields[n].side==="left"?o[0]:o[2]:s.lhs_module!==s.rhs_module?u=t===s.rhs_module?o[0]:o[2]:u=o[0]==="many"||o[2]==="many"?"many":"one",u==="many"},getRelateFields:function(t,n){var r=e.metadata.getModule(t).fields[n].relationship,i=this.getRelatedModule(t,n),s=e.metadata.getModule(i).fields,o=_.find(s,function(e){return e.type=="link"&&e.relationship==r});return o&&(o=_.filter(s,function(e){return e.type=="relate"&&e.link==o.name})),o||[]},getRelationshipFields:function(t,n){var r=null,i=e.metadata.getModule(t).fields[n];if(i.rel_fields){var s=i.relationship,o=this.getRelatedModule(t,n),u=e.metadata.getModule(o).fields,a=_.find(u,function(e){return e.type=="link"&&e.relationship==s});a&&(a=_.find(u,function(e){return e.link==a.name&&e.link_type=="relationship_info"}));if(a&&a.relationship_fields){var f=_.keys(i.rel_fields);_.each(a.relationship_fields,function(e,t){_.include(f,t)&&(r||(r=[]),r.push(e))})}}return r},getRelatedModule:function(t,n){var r=e.metadata.getModule(t);if(!r||!r.fields||!r.fields[n])return!1;var i=r.fields[n]&&r.fields[n].relationship,s=e.metadata.getRelationship(i);return s?r.fields[n].module||(t===s.rhs_module?s.lhs_module:s.rhs_module):r.fields[n].module||!1},getEditableFields:function(t,n,r){var i=["id"],s=["parent","relate"];return n=n||[],n.length==0&&(n=_.keys(t.attributes)),_.each(n,function(n){var r;t.has(n)&&t.fields[n]&&(!t.fields[n].source||t.fields[n].source!=="non-db"||!t.fields[n].type||s.indexOf(t.fields[n].type)===-1)&&e.acl.hasAccessToModel("edit",t,n)&&(r=t.get(n),r&&t.fields[n].type==="collection"?_.each(r.links,function(e){i.push(e.link.name)}):i.push(n))}),t.toJSON({fields:i})},sync:function(t,n,r){e.logger.trace("data-sync-"+(r.relate?"relate-":"")+t+": "+n),r=this.parseOptionsForSync(t,n,r);var i=this.getSyncCallbacks(t,n,r),s=null;n.dataFetched=!1,this.trigger("data:sync:start",t,n,r),n.trigger("data:sync:start",t,r);if(_.isFunction(r.endpoint))r.endpoint(t,n,r,i);else if(r.relate===!0){var o=null;if(t=="create"||t=="update")o=this.getEditableFields(n,r.fields),t=="update"&&n.link.isNew&&(t="create");s=e.api.relationships(t,n.link.bean.module,{id:n.link.bean.id,link:n.link.name,relatedId:n.id,related:o},r.params,i,r.apiOptions)}else r.favorite?s=e.api.favorite(n.module,n.id,n.isFavorite(),i,r.apiOptions):r.following?s=e.api.follow(n.module,n.id,n.get("following"),i,r.apiOptions):r.query||n instanceof e.MixedBeanCollection?s=e.api.search(r.params,i,r.apiOptions):n.module?s=e.api.records(t,n.module,t=="update"||t=="create"?this.getEditableFields(n,r.fields):n.attributes,r.params,i,r.apiOptions):e.logger.error("Unable to sync model with no module");return s},parseOptionsForSync:function(t,n,r){r=r||{},r.params=r.params||{},r.filterDef=r.filter||n.filterDef,r.view&&_.isString(r.view)&&t=="read"&&(r.params.view=r.view),r.fields&&t=="read"&&(r.params.fields=r.fields.join(",")),r.viewed===!0&&(r.params.viewed="1");if(t=="read"&&n instanceof e.BeanCollection){r.offset&&r.offset!==0&&(r.params.offset=r.offset);if(r.limit||e.config&&e.config.maxQueryResult)r.params.max_num=r.limit||e.config.maxQueryResult;n.orderBy&&n.orderBy.field&&(r.params.order_by=n.orderBy.field+":"+n.orderBy.direction),r.myItems===!0&&(r.params.my_items="1"),r.favorites===!0&&(r.params.favorites="1");if(!_.isEmpty(r.filterDef)){var i=e.utils.deepCopy(r.filterDef);_.has(i,"filter")&&(i=i.filter),_.isArray(i)||(i=[i]),r.params.filter=i}_.isEmpty(r.query)||(r.params.q=r.query,_.isEmpty(r.module_list)&&n.module&&(r.module_list=[n.module])),r.module_list&&(r.params.module_list=r.module_list.join(","))}return t==="update"&&r.lastModified&&(r.apiOptions=r.apiOptions||{},r.apiOptions.headers=r.apiOptions.headers||{},r.apiOptions.headers["X-TIMESTAMP"]=r.lastModified),r},getSyncCallbacks:function(e,t,n){return{success:this.getSyncSuccessCallback(e,t,n),error:this.getSyncErrorCallback(e,t,n),complete:this.getSyncCompleteCallback(e,t,n),abort:this.getSyncAbortCallback(e,t,n)}},getSyncSuccessCallback:function(t,n,r){var i=this;return function(s,o){n.inSync=!0,n.original_assigned_user_id=n.get("assigned_user_id"),t=="read"&&n instanceof e.BeanCollection&&(s=s||{},s.next_offset&&(n.offset=s.next_offset!=-1?s.next_offset:n.offset+(s.records||[]).length,n.next_offset=s.next_offset,n.page=n.getPageNumber(r)),s=s.records||[],i._updateCollectionProperties(n,r));if(r.relate===!0){n.link.isNew=!1;if(t!="read"){if(n.link.bean){var u=n.link.bean.getSyncedAttributes(),a=_.reduce(s.record,function(e,t,n){return _.isEqual(u[n],t)||(e[n]=t),e},{});n.link.bean.set(a),n.link.bean.setSyncedAttributes(s.record)}s=s.related_record,t=="delete"&&(n.set(s),delete n.link)}}n.dataFetched=!0,r.success&&r.success(n,s,r),n.trigger("sync",n,s,r,o),i.trigger("data:sync:success",t,n,r,o),n.inSync=null}},getSyncErrorCallback:function(t,n,r){return _.bind(function(i){if(i.request.aborted){var s=this.getSyncAbortCallback(t,n,r);return s(i.request)}e.error.handleHttpError(i,n,r),this.trigger("data:sync:error",t,n,r,i),n.trigger("data:sync:error",t,r,i),_.isFunction(r.error)&&r.error(i)},this)},getSyncCompleteCallback:function(e,t,n){return _.bind(function(r){this.trigger("data:sync:complete",e,t,n,r),t.trigger("data:sync:complete",e,n,r),_.isFunction(n.complete)&&n.complete(r)},this)},getSyncAbortCallback:function(e,t,n){return _.bind(function(r){this.trigger("data:sync:abort",e,t,n,r),t.trigger("data:sync:abort",e,n,r)},this)},_updateCollectionProperties:function(e,t){t=t||{},e.myItems=t.myItems,e.favorites=t.favorites,e.query=t.query,e.modelList=t.modelList,e.filterDef=t.filterDef}},Backbone.Events);e.augment("data",r,!1)}(SUGAR.App),function(e){e.augment("validation",{validators:function(){var t=function(e,t,n){var r=_.isUndefined(e[n])?e.validation?e.validation[n]:null:e[n];if(_.contains(["int","float","decimal","currency"],e.type)&&_.isFinite(r)){e.type=="int"?t=parseInt(t):t=parseFloat(t);if(n=="max"){if(t>r)return r}else if(n=="min"){if(t<r)return r}else if(n=="greaterthan"){if(t<=r)return r}else if(n=="lessthan"&&t>=r)return r}},n=function(t,n,r,i){if(_.indexOf(["date","datetimecombo"],t.type)!==-1&&t.validation&&t.validation.type===r){var s=i.fields[t.validation.compareto];if(!_.isUndefined(s)&&_.indexOf(["date","datetimecombo"],s.type)!=-1){var o=Date.parse(i.get(s.name));n=Date.parse(n.toString());if(!_.isNaN(o)&&!_.isNaN(n)){var u=e.lang.get(s.label||s.vname||s.name,i.module);if(r=="isbefore")return o<n?u:undefined;if(r=="isafter")return o>n?u:undefined}}}};return{maxLength:function(e,t){_.isNumber(t)&&(t=t.toString());if(_.isNumber(e.len)&&_.isString(t)){var n=e.len;t=t||"",t=t.toString();if(t.length>n)return n}},minLength:function(e,t){if(_.isNumber(e.minlen)){var n=e.minlen;t=t||"",t=t.toString();if(t.length<n)return n}},url:function(e,t){},email:function(t,n){var r;if(t.type=="email"||t.type==="email-text"){n.length>0&&_.each(n,function(n){if(!(n.email_address!==""||!_.isUndefined(t.required)&&t.required!=0))return;e.utils.isValidEmailAddress(n.email_address)||(r||(r=[]),r.push(n.email_address))});if(r&&r.length>0)return r}},primaryEmail:function(e,t){if(e.type=="email"&&t.length>0&&!_.find(t,function(e){return e.primary_address=="1"}))return!0},duplicateEmail:function(e,t){if(e.type=="email"){var n=_.pluck(t,"email_address"),r=[],i=n.length,s,o;for(s=0;s<i;s++)for(o=s+1;o<i;o++)n[s]==n[o]&&r.push(n[s]);if(r&&r.length>0)return r}},datetime:function(t,n){function c(e,t,n){var r=parseInt(e,10);return!isNaN(r)&&r>=t&&r<=n}var r,i,s,o,u,a,f,l;if(t.type==="date"||t.type==="datetimecombo"){if(_.isNaN(Date.parse(n))&&_.isNaN(Date.parse(n.replace(/[\.\-]/g,"/"))))return n;if(!e.date.isIso(n)){a=n.replace(/[\.\-]/g,"/").split("/"),i=_.filter(a,function(e,t){return e.length===3||e.length>4});if(i.length)return n;if(/([\.\/\-])\1/.test(n)===!0)return n;s=e.user.getPreference("datepref"),o=s.match(/[.\/\-\s].*?/),u=s.split(o);for(f=0,l=u.length;f<l;f++){r=a[f];switch(u[f].toLowerCase().charAt(0)){case"m":if(!c(r,1,12))return n;break;case"d":if(!c(r,1,31))return n}}}else if(n.charAt(0)==="0")return n}},minValue:function(e,n){return t(e,n,"min")},maxValue:function(e,n){return t(e,n,"max")},greaterThan:function(e,n){return t(e,n,"greaterthan")},lessThan:function(e,n){return t(e,n,"lessthan")},number:function(e,t){if(_.indexOf(["int","float","currency"],e.type)!=-1)return _.isBoolean(t)||_.isString(t)&&t.trim().length==0||isNaN(parseFloat(t))||!_.isFinite(t)?!0:undefined},isBefore:function(e,t,r){return n(e,t,"isbefore",r)},isAfter:function(e,t,r){return n(e,t,"isafter",r)}}}(),requiredValidator:function(e,t,n,r){if(e.required===!0&&t!=="id"&&e.type!=="image"&&_.isUndefined(e.auto_increment)){var i=n.get(t),s=_.isUndefined(i),o=_.isNull(r)||r===""||r===!1||_.isArray(r)&&this._isArrayEmpty(r)||r instanceof Backbone.Collection&&r.length==0;if(s&&_.isUndefined(r)||o)return!0}},_isArrayEmpty:function(e){return _.every(e,_.isEmpty)}},!1)}(SUGAR.App),function(e){Handlebars.registerHelper("field",function(t,n){var r=e.view.createField({def:this,view:t,model:n.hash.model,viewName:n.hash.template});return n.hash.parent&&_.isArray(n.hash.parent.fields)&&n.hash.parent.fields.push(r),r.getPlaceholder()}),Handlebars.registerHelper("fieldOfType",function(t,n){var r={type:t,name:t,label:n},i=e.view.createField({def:r,view:this});return i.getPlaceholder()}),Handlebars.registerHelper("eachOptions",function(t,n){var r,i="",s;return r=_.isString(t)?e.lang.getAppListStrings(t):t,_.isArray(r)?s=function(e,t){i+=n.fn({key:t,value:e})}:_.isObject(r)?s=function(e,t){i+=n.fn({key:t,value:e})}:r=null,r&&_.each(r,s,this),i}),Handlebars.registerHelper("buildRoute",function(t){var n=t.hash.context,r=t.hash.model||(n&&n.get("model")?n.get("model"):{}),i=t.hash.module||r.module||(n&&n.get("module")?n.get("module"):null),s=t.hash.id||r.id,o=t.hash.action;return e.router.buildRoute(i,s,o)}),Handlebars.registerHelper("getFieldValue",function(t,n,r){return e.logger.warn("getFieldValue handlebars helper is deprecated and will be removed in 7.8. Please use the fieldValue handlebars helper instead."),r=_.isObject(r)?"":r,t.get(n)||r||""}),Handlebars.registerHelper("fieldValue",function(e,t,n){return e.get(t)||n.hash.defaultValue||""}),Handlebars.registerHelper("has",function(e,t,n){return!_.isArray(t)&&!_.isObject(t)&&(t=[t]),_.include(t,e)?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notHas",function(e,t,n){var r=n.fn,i=n.inverse;return n.fn=i,n.inverse=r,Handlebars.helpers.has.call(this,e,t,n)}),Handlebars.registerHelper("isSortable",function(t,n,r){return e.utils.isSortable(t,n)?r.fn(this):""}),Handlebars.registerHelper("eq",function(e,t,n){return e==t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notEq",function(e,t,n){
return e!=t?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("match",function(e,t,n){var r=new RegExp(t);return r.test(e)?n.fn(this):n.inverse(this)}),Handlebars.registerHelper("notMatch",function(e,t,n){var r=new RegExp(t);return r.test(e)?n.inverse(this):n.fn(this)}),Handlebars.registerHelper("log",function(t){e.logger.debug("*****HBS: Current Context*****"),e.logger.debug(this),e.logger.debug("*****HBS: Current Value*****"),e.logger.debug(t),console.log(t),e.logger.debug("***********************")}),Handlebars.registerHelper("str",function(t,n,r){return n=_.isString(n)?n:null,e.lang.get(t,n,r)}),Handlebars.registerHelper("timeago",function(t,n){e.logger.warn("The helper `timeago` is deprecated since 7.2.0. Please upgrade your code to use `relativeTime`.");var n=_.isString(n)?" data-label='"+n+"' ":"",r=e.date(t).formatUser(),i='<span class="relativetime" '+n+' title="'+t+'">'+r+"</span>";return new Handlebars.SafeString(i)}),Handlebars.registerHelper("relativeTime",function(t,n){var r=e.date(t),i,s;return n.hash.title=n.hash.title||r.formatUser(n.hash.dateOnly),i=_.map(n.hash,function(e,t){return t+'="'+Handlebars.Utils.escapeExpression(e)+'"'}).join(" "),s='<time datetime="'+r.format()+'" '+i+">"+r.fromNow()+"</time>",new Handlebars.SafeString(s)}),Handlebars.registerHelper("arrayJoin",function(e,t){return e.join(t)}),Handlebars.registerHelper("nl2br",function(e){e=Handlebars.Utils.escapeExpression(e);var t=e.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br>");return new Handlebars.SafeString(t)}),Handlebars.registerHelper("formatCurrency",function(t,n){return _.isObject(n)&&(n=n.hash.currencyId||undefined),e.currency.formatAmountLocale(t,n)}),Handlebars.registerHelper("firstChars",function(e,t){return e.substring(0,t)}),Handlebars.registerHelper("formatDate",function(t,n){var t=e.date(t);return t.formatUser(n.hash.dateOnly)}),Handlebars.registerHelper("getModuleName",function(t,n){var n={plural:n.hash.plural,defaultValue:n.hash.defaultValue};return e.lang.getModuleName(t,n)}),Handlebars.registerHelper("partial",function(t,n,r){var i,s,o;r=r||{},r.hash=r.hash||{},n=n||this,o=r.hash.component||this,i=r.hash.module||o.module;if(o&&o.options.templateOptions&&o.options.templateOptions.partials)s=o.options.templateOptions.partials[t];else if(o instanceof e.view.Field){var u=r.hash.fallbackTemplate;s=e.template.getField(o.name,t||"detail",i,u)}else o instanceof e.view.View?s=e.template.getView(o.name+"."+t,i)||e.template.getView(o.name+"."+t):o instanceof e.view.Layout&&(s=e.template.getLayout(o.name+"."+t,i)||e.template.getLayout(o.name+"."+t));return new Handlebars.SafeString(s?s(n):"")})}(SUGAR.App),function(e){var t=0,n=[],r={reset:function(){_.each(this.layouts,function(e,t){delete this.layouts[t]},this),_.each(this.views,function(e,t){delete this.views[t]},this),_.each(this.fields,function(e,t){delete this.fields[t]},this)},getFieldId:function(){return t},views:{},layouts:{},fields:{},_createComponent:function(e,t,n){var r=this.declareComponent(e,n.type||t,n.module,n.controller,!1,this._getPlatform(n)),i=new r(n);return i.trigger("init"),i.bindDataChange(),i},createView:function(t){return t.context=t.context||e.controller.context,t.module=t.module||t.context.get("module"),t.meta=t.meta||e.metadata.getView(t.module,t.name),t.type=t.type||(t.meta&&t.meta.type?t.meta.type:t.name||null),this._createComponent("view",t.name,t)},createLayout:function(t){return t.context=t.context||e.controller.context,t.module=t.module||t.context.get("module"),t.meta=t.meta||e.metadata.getLayout(t.module,t.name),t.type=t.type||(t.meta?t.meta.type:null),this._createComponent("layout",t.name||t.type,t)},createField:function(n){var r=n.def.type;n.context=n.context||n.view.context||e.controller.context,n.model=n.model||n.context.get("model"),n.module=n.module||(n.model&&n.model.module?n.model.module:n.context.get("module"))||"",n.meta=n.meta||e.metadata.getField(r,n.module),n.meta&&n.meta.controller&&(n.controller=n.meta.controller),n.sfId=++t;var i=this._createComponent("field",r,n);return n.view.fields[i.sfId]=i,i},_getPlatform:function(t){return t.platform||(e.config&&e.config.platform?e.config.platform:"base")},_getController:function(e){var t=this._getBaseComponent(e.type,e.name,e.module,e.platform);return t.cache[t.moduleBasedClassName]?t.cache[t.moduleBasedClassName]:t.baseClass},invokeParent:function(t,n){var r,i;return n=n||{},(!t||!n.type||!n.name||!n.method||n.args&&!_.isArray(n.args))&&e.logger.error("view-manager's invoke method requires a context, params.type, params.name, params.method; if params.args is supplied it must be of type array."),r=this._getController(n),r?(t._superStack=t._superStack||{},t._superStack[n.method]=t._superStack[n.method]||[],t._superStack[n.method].push(r.prototype),i=r.prototype[n.method].apply(t,n.args),t._superStack[n.method].pop(),i):e.logger.error("invokeParent: Unable to load controller for "+n.type+":"+n.name)},componentHasPlugin:function(t){var n;return!t.type||!t.name||!t.plugin?(e.logger.error("componentHasPlugin requires type, name, and plugin parameters"),null):(n=this._getController(t),n&&n.prototype&&_.contains(n.prototype.plugins,t.plugin))},declareComponent:function(t,n,r,i,s,o){var u=this._getBaseComponent(t,n,r,o,s&&i);return s&&i&&u.cache[u.moduleBasedClassName]&&delete u.cache[u.moduleBasedClassName],u.cache[u.moduleBasedClassName]||e.utils.extendClass(u.cache,u.baseClass,u.moduleBasedClassName,i,u.platformNamespace)||u.baseClass},_getBaseComponent:function(t,n,r,i,s){i=this._getPlatform({platform:i});var o=e.utils.capitalize(t),u=e.utils.capitalize(i),a=e.utils.capitalizeHyphenated(n)+o,f=u+(r||"")+a,l=u+(r||"")+"Custom"+a,c=e.view[t+"s"],h=e.utils.capitalize(e.config.appId)+o,p=c[u+"Custom"+a]||c[u+a]||c["BaseCustom"+a]||c["Base"+a]||c[a]||c["BaseBase"+o]||e.view["Custom"+h]||e.view[h]||e.view[o];return c[l]&&!s&&(f=l),{cache:c,platformNamespace:u,moduleBasedClassName:f,baseClass:p}}};e.augment("view",r,!1)}(SUGAR.App),function(e){e.view.Component=Backbone.View.extend({initialize:function(t){this.context=t.context||e.controller.context,this.meta=t.meta,this.module=t.module||this.context.get("module"),this.model=t.model||this.context.get("model"),this.collection=t.collection||this.context.get("collection"),this.meta&&this.meta.css_class&&this.$el.addClass(this.meta.css_class),e.user.lastState.register(this)},_render:function(){return this},render:function(){return this.disposed===!0?(e.logger.error("Unable to render component because it's disposed "+this+"\n"),!1):this.triggerBefore("render")?(this._render(),this.trigger("render"),this):!1},setTemplateOption:function(e,t){this.options=this.options||{},this.options.templateOptions=this.options.templateOptions||{},this.options.templateOptions[e]=_.extend({},this.options.templateOptions[e],t)},bindDataChange:function(){},unbindData:function(){this.model&&this.model.off(null,null,this),this.collection&&this.collection.off(null,null,this)},unbind:function(){this.off(),this.offBefore(),this.undelegateEvents(),e.events.off(null,null,this),e.events.unregister(this),this.context&&this.context.off(null,null,this),this.layout&&this.layout.off(null,null,this)},loadData:function(){},_dispose:function(){this.unbindData(),this.unbind(),this.remove(),this.model=null,this.collection=null,this.context=null,this.$el=null,this.el=null},dispose:function(){if(this.disposed===!0)return;this._dispose(),this.disposed=!0},toString:function(){return this.cid+"-"+(this.$el&&this.$el.id?this.$el.id:"<no-id>")+"/"+this.module+"/"+this.model+"/"+this.collection},closestComponent:function(e){},show:function(){if(!this.isVisible()){if(!this.triggerBefore("show"))return!1;this.$el.removeClass("hide").show(),this.trigger("show")}},hide:function(){if(this.isVisible()){if(!this.triggerBefore("hide"))return!1;this.$el.addClass("hide").hide(),this.trigger("hide")}},isVisible:function(){return this.$el.css("display")!=="none"},_super:function(t,n){if(!t||!_.isString(t))return e.logger.error("tried to call _super without specifying a parent method in "+this.name);var r,i=null,s=Object.getPrototypeOf(this);n=n||[],this._superStack=this._superStack||{},this._superStack[t]=this._superStack[t]||[];if(this._superStack[t].length>0){r=Object.getPrototypeOf(_.last(this._superStack[t]));if(_.contains(this._superStack[t],r))return e.logger.error("Loop detected calling "+t+" from "+this.name)}else r=Object.getPrototypeOf(s);if(!s[t])return e.logger.error("Unable to find method "+t+" on class "+this.name);while(!r.hasOwnProperty(t)&&r!==e.view.Component.prototype)r=Object.getPrototypeOf(r);while(s[t]===r[t]&&r!==e.view.Component.prototype)s=r,r=Object.getPrototypeOf(r);this._superStack[t].push(r);if(!r)return e.logger.error("Unable to find parent of component "+this.name);if(!r[t])return e.logger.error("Unable to find method "+t+" on parent class of "+this.name);var o=r[t].apply(this,n);return this._superStack[t].pop(),_.isEmpty(this._superStack[t])&&(this._superStack[t]=null),o}}),_.extend(e.view.Component.prototype,e.beforeEvent)}(SUGAR.App),function(e){e.view.View=e.view.Component.extend({initialize:function(t){e.plugins.attach(this,"view"),e.view.Component.prototype.initialize.call(this,t),this.name=t.name,this.action=t.meta&&t.meta.action?t.meta.action:this.name,this.template=t.template||this.getTemplateFromMeta(t)||e.template.getView(this.name,this.module)||e.template.getView(this.name)||(t.meta&&t.meta.type?e.template.getView(t.meta.type):null),this.fields={},this.fallbackFieldTemplate=this.fallbackFieldTemplate||"detail",this.layout=this.options.layout,this.primary=t.primary,this._setLabels(),e.events.on("app:locale:change",function(){this._setLabels()},this)},getTemplateFromMeta:function(t){return t.meta&&t.meta.template?e.template.getView(t.meta.template):null},_renderHtml:function(t,n){if(this.template)try{this.$el.html(this.template(t||this,n||this.options.templateOptions)),this.delegateEvents()}catch(r){e.logger.error("Failed to render "+this+"\n"+r),e.error.handleRenderError(this,"_renderHtml")}},_renderFields:function(){var e=this,t={};this.$("span[sfuuid]").each(function(){var e=$(this),n=e.attr("sfuuid");t[n]=e}),_.each(this.fields,function(n){e._renderField(n,t[n.sfId])})},_renderField:function(t,n){t.setElement(n||this.$("span[sfuuid='"+t.sfId+"']"));try{t.render()}catch(r){e.logger.error("Failed to render "+t+" on "+this+"\n"+r),e.error.handleRenderError(this,"_renderField",t)}},_render:function(){return e.acl.hasAccessToModel(this.action,this.model)?(this._disposeFields(),this._renderHtml(),this._renderFields()):(e.logger.info("Current user does not have access to this module view. name: "+this.name+" module:"+this.module),this.primary&&e.error.handleRenderError(this,"view_render_denied")),this},_setLabels:function(){this.modulePlural=e.lang.getAppListStrings("moduleList")[this.module]||this.module,this.moduleSingular=e.lang.getAppListStrings("moduleListSingular")[this.module]||this.modulePlural},loadData:function(t,n){e.acl.hasAccess("read",this.module)&&(n=_.isUndefined(n)?!0:n,n&&this.context.set("fields",this.getFieldNames()),this.context.loadData(t))},getFieldNames:function(t,n){var r=[];t=t||this.context.get("module"),this.meta&&this.meta.panels&&(r=_.reduce(_.map(this.meta.panels,function(e){var t=_.flatten(_.compact(_.pluck(e.fields,"fields")));return _.pluck(e.fields,"name").concat(_.pluck(t,"name")).concat(_.flatten(_.compact(_.pluck(e.fields,"related_fields"))))}),function(e,t){return e.concat(t)},[])),r=_.compact(_.uniq(r));var i=e.metadata.getModule(t,"fields");if(i){r=_.reject(r,function(e){return _.isUndefined(i[e])});var s=[];_.each(r,function(e){i[e].type=="relate"?s.push(i[e].id_name):i[e].type=="parent"&&(s.push(i[e].id_name),s.push(i[e].type_name)),_.isArray(i[e].fields)&&(s=s.concat(i[e].fields))}),r=_.union(r,s)}return r},getFields:function(e,t){var n={},r=this.getFieldNames(e);return _.each(r,function(e){var r=this.getField(e,t);r&&(n[e]=r.def)},this),n},getField:function(e,t){return _.find(this.fields,function(n){return n.name==e&&(!t||n.model==t)})},closestComponent:function(e){if(!this.layout)return;return this.layout.name===e?this.layout:this.layout.closestComponent(e)},_dispose:function(){e.plugins.detach(this,"view"),this._disposeFields(),e.view.Component.prototype._dispose.call(this)},_disposeFields:function(){_.each(this.fields,function(e){e.dispose()}),this.fields={}},toString:function(){return"view-"+this.name+"-"+e.view.Component.prototype.toString.call(this)},getFieldMeta:function(e){var t=_.find(_.flatten(_.pluck(this.meta.panels,"fields")),function(t){return t.name==e});return t},setFieldMeta:function(e,t){_.each(this.meta.panels,function(n){_.each(n.fields,function(r,i){r.name==e&&(n.fields[i]=_.extend(r,t))})})}})}(SUGAR.App),function(e){e.view.Field=e.view.Component.extend({fieldTag:"input",initialize:function(t){e.plugins.attach(this,"field"),e.view.Component.prototype.initialize.call(this,t),this.sfId=t.sfId,this.view=t.view,this.name=this.options.def.name,this.type=this.options.def.type;if(this.model&&this.model.fields){var n=_.clone(this.model.fields[this.name]);this.def=n?_.extend(n,t.def):t.def}else this.def=this.options.def;this.label=e.lang.get(this.def.label||this.def.vname||this.name,this.module),this.template=e.template.empty,this.model&&(this.model.on("error:validation:"+this.name,this.handleValidationError,this),this.model.on("validation:start attributes:revert",this.removeValidationErrors,this))},viewFallbackMap:{edit:"detail"},_checkAccessToAction:function(t){return e.acl.hasAccessToModel(t,this.model,this.name)},_getFallbackTemplate:function(e){return this.isDisabled()&&e==="disabled"?"edit":this.view.fallbackFieldTemplate||"detail"},_loadTemplate:function(){var t,n=this.options.viewName||this.options.def.view||(this.view.meta&&this.view.meta.type?this.view.meta.type:this.view.name),r=this.action;this.isDisabled()&&n==="edit"?n=this.action:r=this.action||(this.view.action&&this.view.name!=this.view.action?this.view.action:n);while(n){if(this._checkAccessToAction(r))break;n=this.viewFallbackMap[n],r=n}if(n){var i=this.module||this.context.get("module");t=this._getFallbackTemplate(n),this.template=e.template.getField(this.type,n,i,t)||e.template.getField("base",n,i,t)||e.template.empty}else this.template=e.template.empty;this.tplName=n,this.action=r},delegateEvents:function(e){e=e||this.events||(this.def?this.def.events:null);if(!e)return;e=_.clone(e),_.each(e,function(t,n){var r=this[t];!r&&_.isString(t)&&(r=_.bind(function(e){_.isFunction(this.triggerMetadataEvent)&&this.triggerMetadataEvent(e,t)},this),this["callback_"+n]=r,e[n]="callback_"+n),!_.isFunction(t)&&!r&&delete e[n]},this),Backbone.View.prototype.delegateEvents.call(this,e)},_render:function(){return this._loadTemplate(),this.model instanceof Backbone.Model&&(this.value=this.getFormattedValue()),this.dir=_.result(this,"direction"),e.lang.direction===this.dir&&delete this.dir,this.unbindDom(),this.$el.html(this.template(this)||""),this.def&&this.def.css_class&&this.getFieldElement().addClass(this.def.css_class),this.$(this.fieldTag).attr("dir",this.dir),this.bindDomChange(),this},getFieldElement:function(){return this.$el},bindDomChange:function(){if(!(this.model instanceof Backbone.Model))return;var e=this,t=this.$el.find(this.fieldTag);t.on("change",function(){e.model.set(e.name,e.unformat(t.val()))})},bindDataChange:function(){this.model&&this.model.on("change:"+this.name,function(e,t){this.action==="edit"?this.$(this.fieldTag).val(this.format(t)):this.render()},this)},format:function(e){return e},unformat:function(e){return e},getFormattedValue:function(){return this.format(this.model.has(this.name)?this.model.get(this.name):null)},handleValidationError:function(e){},removeValidationErrors:function(){},getPlaceholder:function(){return new Handlebars.SafeString('<span sfuuid="'+this.sfId+'"></span>')},setDisabled:function(e){e=_.isUndefined(e)?!0:e,e&&this.isDisabled()===!1?(this._previousAction=this.action,this.action="disabled",this.render()):e===!1&&this.isDisabled()&&(this.action=this._previousAction,delete this._previousAction,this.render())},isDisabled:function(){return this.action==="disabled"},setViewName:function(e){this.options.viewName=e},setMode:function(e){this.isDisabled()?this._previousAction=e:this.action=e,this.setViewName(e),this.render()},unbindDom:function(){this.$el.find(this.fieldTag).off()},_dispose:function(){e.plugins.detach(this,"field"),this.unbindDom(),e.view.Component.prototype._dispose.call(this)},toString:function(){return"field-"+this.name+"-"+this.sfId+"-"+e.view.Component.prototype.toString.call(this)},show:function(){if(!this.isVisible()){if(!this.triggerBefore("show"))return!1;this.getFieldElement().removeClass("hide").show(),this.trigger("show")}},hide:function(){if(this.isVisible()){if(!this.triggerBefore("hide"))return!1;this.getFieldElement().addClass("hide").hide(),this.trigger("hide")}},isVisible:function(){return this.getFieldElement().css("display")!=="none"},equals:function(e){return this.type===e.type&&_.isEqual(this.getFormattedValue(),e.getFormattedValue())},closestComponent:function(e){if(!this.view)return;return this.view.name===e?this.view:this.view.closestComponent(e)}})}(SUGAR.App),function(e){e.view.Layout=e.view.Component.extend({initialize:function(t){e.plugins.attach(this,"layout"),e.view.Component.prototype.initialize.call(this,t),this._components=[],this.meta=this.meta||{},this.type=this.meta.type||this.options.type,this.name=this.meta.name||this.options.name||this.type||"",this.meta.label?this.label=this.meta.label:this.options.def&&this.options.def.label?this.label=this.options.def.label:this.options.label?this.label=this.options.label:this.label="",this.template=e.template.getLayout(this.name,this.module)||e.template.getLayout(this.type,this.module)||e.template.getLayout(this.name)||e.template.getLayout(this.type),this.template&&this.$el.html(this.template(this,t)),this.layout=this.options.layout,this._addComponentsFromDef(this.meta.components),this.trigger("init"),e.events.on("app:locale:change",function(){this.render()},this)},createComponentFromDef:function(t,n,r){n=n||this.context,r=r||this.module,t.context&&(t.context instanceof e.Context?n=t.context:(n=n.getChildContext(t.context),n.prepare()),r=n.get("module"));if(t.view){if(_.isString(t.view))return e.view.createView({context:n,name:t.view,module:r,primary:t.primary,layout:this});if(_.isObject(t.view))return e.view.createView({context:n,module:r,meta:t.view.meta||t.view,name:t.view.name||t.view.type||"",primary:t.view.primary,layout:this})}else if(t.layout){if(_.isString(t.layout))return e.view.createLayout({context:n,name:t.layout,def:t,module:r,layout:this});if(_.isObject(t.layout))return e.view.createLayout({context:n,module:r,meta:t.layout.meta||t.layout,name:t.layout.name||t.layout.type||"",def:t,layout:this})}else e.logger.warn("Invalid layout definition:\n"+t.layout)},_addComponentsFromDef:function(e,t,n){_.each(e||{},function(e){(e.view||e.layout)&&this.addComponent(this.createComponentFromDef(e,t,n),e)},this)},addComponent:function(e,t){e.layout||(e.layout=this),this._components.push(e),this._placeComponent(e,t)},_placeComponent:function(e){this.$el.append(e.el)},removeComponent:function(e){var t=_.isNumber(e)?e:this._components.indexOf(e);if(t>-1){var n=this._components.splice(t,1);n[0].layout=null}},getComponent:function(e){return _.find(this._components,function(t){return t.name===e})},_render:function(){return this._components&&this._components.length>0?_.each(this._components,function(e){e.render()},this):e.logger.info("Can't render anything because the layout has no components: "+this.toString()+"\n"+"Either supply metadata or override Layout.render method"),this},loadData:function(e,t){if(this.disposed)return;t=_.isUndefined(t)?!0:t,t&&this.context.set("fields",this.getFieldNames()),this.context.loadData(e),_.each(this._components,function(t){t.loadData(e,t.context!=this.context)},this)},getFieldNames:function(e){var t=[];return e=e||this.module,_.each(this._components,function(n){n.module==e&&(t=_.union(t,n.getFieldNames(null,!0)))},this),t},getFields:function(e){var t={};return _.each(this._components,function(n){_.extend(t,n.getFields(e))}),t},closestComponent:function(e){if(!this.layout)return;return this.layout.name===e?this.layout:this.layout.closestComponent(e)},_dispose:function(){e.plugins.detach(this,"layout"),_.each(this._components,function(e){e.dispose()}),this._components=[],e.view.Component.prototype._dispose.call(this)},toString:function(){return"layout-"+(this.options.type||this.options.name)+"-"+e.view.Component.prototype.toString.call(this)}})}(SUGAR.App),function(e){var t={},n={preventAnyAlert:!1,init:function(){this.$alerts=$(e.config.alertsEl||"#alerts"),this.klass=e.view[e.utils.capitalize(e.config.appId)+"AlertView"]||e.view.views[e.utils.capitalize(e.config.platform)+"AlertView"]||e.view.views.BaseAlertView||e.view[e.utils.capitalize(e.config.platform)+"AlertView"]||e.view.AlertView},show:function(n,r){if(!this.$alerts||this.$alerts.length==0)return null;if(this.preventAnyAlert)return null;r=_.extend({level:"info",autoClose:!1},r||{}),r.level==="confirmation"&&(this.dismissAll(),this.preventAnyAlert=!0),_.isUndefined(r.closeable)&&(r.closeable=r.level!="info"),r.messages&&(r.messages=_.isString(r.messages)?[r.messages]:r.messages);var i=t[n];i||(i=this._create(n,r),t[n]=i),i.level=r.level,!r.autoClose||this._setAutoCloseTimer(i,r.onAutoClose,r.autoCloseDelay),i.render(r);if(r.closeable){var s=i.getCloseSelector();s.off("click"),s.on("click",_.bind(function(){this.dismiss(n)},this)),e.accessibility&&e.accessibility.run(s,"click")}return i},_create:function(e,t){var n=new this.klass(t);return n.key=e,n.$el.prependTo(this.$alerts),n},_setAutoCloseTimer:function(t,n,r){t.timerId&&clearTimeout(t.timerId),t.timerId=setTimeout(_.bind(function(){_.isFunction(n)&&n(t.key),this.dismiss(t.key)},this),r||e.config.alertAutoCloseDelay||9e3)},dismiss:function(e,n){this.preventAnyAlert=!1;var r=t[e];if(!r)return;r.timerId&&clearTimeout(r.timerId),r.close(n),delete t[e]},dismissAll:function(e,n){_.each(t,function(t,r){(!e||t.level==e)&&this.dismiss(r,n)},this)},get:function(e){return t[e]},getAll:function(){return t}};e.augment("alert",n,!1),e.view.AlertView=e.view.View.extend({className:"alert",tpl:"alert",close:function(){this.getCloseSelector().off("click"),this.$el.remove()},getCloseSelector:function(){return this.$(".close")},render:function(t){t=t||{},t.closeable&&this.$el.addClass("closeable"),this.$el.addClass("alert-"+t.level);var n=e.template.get(t.tpl||this.tpl)||e.template.empty;this.$el.html(n(t))}})}(SUGAR.App),function(e){var t=500,n=25,r=75;e.augment("tutorial",{instance:null,hasTutorial:function(t,n){_.isUndefined(n)&&(n=e.controller.context.get("module")),_.isUndefined(t)&&(t=e.controller.context.get("layout"));var r=e.metadata.getModule(n),i=e.metadata.getView("","tutorial");return i&&(this.data=i),r&&r.views&&r.views.tutorial&&r.views.tutorial.meta&&r.views.tutorial.meta[t]?!0:this.data&&this.data[t]?!0:!1},show:function(t,n){if(e.config.skipTutorial)return;if(e.tutorial.data)this.doTutorial(t,n);else if(e.metadata.getView("","tutorial"))e.tutorial.data=e.metadata.getView("","tutorial"),this.doTutorial(t,n);else{var r=this;$.getJSON(e.config.tutorualURL||"tutorial.json",function(i){e.tutorial.data=i,r.doTutorial(t,n)})}},doTutorial:function(t,n){var r=e.tutorial.data[t],i=t;if(n&&n.module){var s=e.metadata.getModule(n.module);s.views&&s.views.tutorial&&s.views.tutorial.meta&&s.views.tutorial.meta[t]&&(r=s.views.tutorial.meta[t],i=t+n.module)}var o=this.getPrefs();if(r&&(!o.skipVersion[i]||o.skipVersion[i]<r.version)&&(!o.viewedVersion[i]||o.viewedVersion[i]<r.version)){var n=_.extend(r,{type:"Tutorial"});e.tutorial.instance=e.view.createView(n),e.tutorial.instance.show(),o.viewedVersion[i]=r.version,e.cache.set("tutorialPrefs",o)}},getPrefs:function(){var t=e.cache.get("tutorialPrefs")||{};return t.viewedVersion=t.viewedVersion||{},t.skipVersion=t.skipVersion||{},t},resetPrefs:function(t){t=t||{},t.viewedVersion={},t.skipVersion={},e.cache.set("tutorialPrefs",t)},skipTutorial:function(){var t=this.getPrefs();_.each(e.tutorial.data,function(n,r){t.skipVersion[r]=e.tutorial.data[r].version}),e.user.setPreference("tutorialPrefs",t)}}),e.view.TutorialView=e.view.View.extend({events:{"click .btn.disabled":function(e){return!1},"click .back-btn:not(.disabled)":"back","click .next-btn:not(.disabled)":"next","click .done-btn":"hide",swipeLeft:"onSwipeLeft"},_duringAnimate:!1,initialize:function(t){t=_.extend({},t||{}),this.index=0,this.setIntro(t.intro),this.setContent(t.content),this.setScroll(t.scroll),e.events.on("router:reauth:load app:logout",this.hide,this)},setContent:function(e){this.content=e},setIntro:function(e){this.intro=e},setScroll:function(e){this.scroll=e},reset:function(){this.index=0},onSwipeLeft:function(t){e.tutorial.skipTutorial(),this.hide(t)},show:function(e){e=_.extend({},e||{}),e.content&&this.setContent(e.content),e.intro&&this.setIntro(e.intro),e.scroll&&this.setScroll(e.scroll),e.reset&&this.reset(),this.render(),this.intro&&!this.introShown?(this.index=-1,this.introShown=!0,this.showMessageOnly(this.intro)):this.highlightItem(this.index)},hide:function(e){e&&e.preventDefault(),this.dispose()},back:function(e){e&&e.preventDefault();if(this._duringAnimate)return;this.highlightItem(this.index-1)},next:function(e){e&&e.preventDefault();if(this._duringAnimate)return;this.highlightItem(this.index+1)},highlightItem:function(e){var n=this;if(e<0)return;if(e>=this.content.length){this.hide();return}var r=this.content[e];if(!r.name)this.showMessageOnly(r.text);else{var i=$(r.name),s=this.index>e?-1:1;if(i.length===0||i.css("display")==="none"||i.parents(".hide").length>0)return this.highlightItem(e+s);var o=function(){this.highlight||(this.highlight=$("<div/>"),this.highlight.attr("id","highlight"),this.highlightText=$("<div/>"),this.highlightText.attr("id","highlight-text"),this.highlight.html(this.highlightText),$("#tutorial-content").html(this.highlight)),this.highlightText.hide(),this.hideGlow(),this._duringAnimate=!0,this.highlight.animate({top:i.offset().top+(r.vertAdj||0),left:i.offset().left+(r.horizAdj||0),width:r.full?i.offset().width:"",height:r.full?i.offset().height:""},t,"linear",function(){n._duringAnimate=!1,(r.glow===undefined||r.glow!==!1)&&n.showGlow(),n.showHighlightText(r.text)})};o=_.bind(o,this),this.scrollToEl(i,o)}e<=0?this.$el.find(".back-btn").addClass("disabled"):this.$el.find(".back-btn").removeClass("disabled"),e>=this.content.length-1?this.$el.find(".next-btn").addClass("disabled"):this.$el.find(".next-btn").removeClass("disabled"),this.index=e},showGlow:function(){this.$el.find("#mask").css("background-image","-webkit-radial-gradient("+(this.highlight.offset().left+this.highlight.width()/2)+"px "+(this.highlight.offset().top+this.getTotalHeight(this.highlight)/2)+"px , "+this.highlight.width()+"px "+this.highlight.height()+"px, transparent, black "+Math.max(this.highlight.width(),this.highlight.height())+"px)"),this.$el.find("#mask").css("background","radial-gradient(circle closest-side at "+(this.highlight.offset().left+this.highlight.width()/2)+"px "+(this.highlight.offset().top+this.getTotalHeight(this.highlight)/2)+"px , "+" transparent 0%, black "+Math.max(this.highlight.width(),this.highlight.height())+"px)"),this.$el.find("#mask").css("background-color","transparent")},hideGlow:function(){this.$el.find("#mask").css("background-color",""),this.$el.find("#mask").css("background-image","")},showHighlightText:function(t){var n;this.highlightText.html(e.lang.get(t,e.controller.context.get("module"))),this.highlightText.show();if(this.highlight.offset().left-this.getTotalWidth(this.highlightText)>0&&this.findIntersectors([this.highlight.offset().left-this.getTotalWidth(this.highlightText),this.highlight.offset().left],[this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2,this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2+this.getTotalHeight(this.highlightText)],".btn-group").length===0){var r=parseInt(this.highlight.css("border-left-width"));this.highlightText.css("left",0-(this.getTotalWidth(this.highlightText)+r)),n=this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2,this.highlightText.css("top",n>=0?n:0),this.highlightText.css("text-align","right")}else if(this.highlight.offset().left+this.getTotalWidth(this.highlight)+this.getTotalWidth(this.highlightText)<$(window).width()&&this.findIntersectors([this.highlight.offset().left+this.getTotalWidth(this.highlight),this.highlight.offset().left+this.getTotalWidth(this.highlight)+this.getTotalWidth(this.highlightText)],[this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2,this.highlight.offset().top+this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2+this.getTotalHeight(this.highlightText)],".btn-group").length===0){var r=parseInt(this.highlight.css("border-right-width"));this.highlightText.css("left",this.getTotalWidth(this.highlight)+r),n=this.getTotalHeight(this.highlight)/2-this.getTotalHeight(this.highlightText)/2,this.highlightText.css("top",n>=0?n:0),this.highlightText.css("text-align","left")}else{var i=this.getTotalWidth(this.highlight)/2-this.getTotalWidth(this.highlightText)/2,s=this.highlight.offset().left+i;i=s<0?0-this.highlight.offset().left:i;var o=this.highlight.offset().left+i+this.getTotalWidth(this.highlightText);i=o>$(window).width()?i-(o-$(window).width()):i;var u;this.highlight.offset().top+this.getTotalHeight(this.highlight)+this.getTotalHeight(this.highlightText)<$(window).height()&&this.findIntersectors([this.highlight.offset().left+i,this.highlight.offset().left+i+this.getTotalWidth(this.highlightText)],[this.highlight.offset().top+this.getTotalHeight(this.highlight),this.highlight.offset().top+this.getTotalHeight(this.highlight)+this.getTotalHeight(this.highlightText)],".btn-group").length===0?u=this.getTotalHeight(this.highlight):u=-5-this.getTotalHeight(this.highlightText),this.highlightText.css("left",i),this.highlightText.css("top",u),this.highlightText.css("text-align","center")}},findIntersectors:function(e,t,n){var r=[],i=this;return this.$el.find(n).each(function(){var n=$(this),s=n.offset(),o=[s.left,s.left+i.getTotalWidth(n)],u=[s.top,s.top+i.getTotalHeight(n)];e[0]<o[1]&&e[1]>o[0]&&t[0]<u[1]&&t[1]>u[0]&&r.push(n)}),r},showMessageOnly:function(t){$("#tutorial-content").html("<div class='text-container'><div class='text'>"+e.lang.get(t,e.controller.context.get("module"))+"</div></div>"),this.highlight=null,this.hideGlow()},getTotalWidth:function(e){var t=e.width();return t+=parseInt(e.css("padding-left"),10)+parseInt(e.css("padding-right"),10),t+=parseInt(e.css("margin-left"),10)+parseInt(e.css("margin-right"),10),t},getTotalHeight:function(e){var t=e.height();return t+=parseInt(e.css("padding-top"),10)+parseInt(e.css("padding-bottom"),10),t+=parseInt(e.css("margin-top"),10)+parseInt(e.css("margin-bottom"),10),t},scrollToEl:function(e,t){var n=$(window).height(),r=e.offset().top,i=e.height(),s=$(".navbar").height()+3||0,o=$("footer").height()||0,u=125,a;$.contains(".navbar",e)&&(s=0),$.contains("footer",e)&&(o=0),r+i>window.pageYOffset+n-o?(a="down",u*=-1):r+i<window.pageYOffset+i+s?a="up":(a="none",t&&_.isFunction(t)&&t()),a!=="none"&&$("#content, .main-pane, .side-pane").animate({scrollTop:r+u},{duration:"fast",complete:function(){t&&_.isFunction(t)&&t()}})},render:function(){var t=e.template.get("tutorial");return $("body").append(t()),e.$contentEl.attr("aria-hidden",!0),this.$el=$("#tutorial"),this.delegateEvents(),this.$el.show(),this},remove:function(){e.$contentEl.removeAttr("aria-hidden"),e.tutorial.instance===this&&(e.tutorial.instance=null),this.highlight&&this.highlight.stop(!0,!0),delete this.highlight,delete this.highlightText,Backbone.View.prototype.remove.call(this)}})}(SUGAR.App);var SUGAR=SUGAR||{};(function(e){var t={eventSplitter:/\s{2,}/,currentViewId:"",init:function(){e.config.analytics&&e.config.analytics.enabled&&e.config.analytics.connector&&e.analytics.connectors[e.config.analytics.connector]?e.on("app:init",function(){e.events.register("app:analytics:init",this),e.analytics.connector=e.analytics.connectors[e.config.analytics.connector],e.analytics.connector.initialize();var t=e.view.Layout.prototype._dispose;e.view.Layout.prototype._dispose=function(){e.analytics.detachAnalytics(this.$el),t.call(this)};var n=e.view.View.prototype._render;e.view.View.prototype._render=function(){e.analytics.detachAnalytics(this.$el),n.call
(this),e.analytics.attachAnalytics(this.$el)}}).on("app:start",function(){e.trigger("app:analytics:init");var t=e.config.analytics.id;t=_.isObject(t)?e.isNative?t["native"]:t.web:t,e.analytics.connector.start(t,e.config.analytics),e.logger.debug("Analytics enabled - "+t)}):(e.logger.debug("Analytics disabled"),this.trackPageView=function(){},this.trackEvent=function(){})},trackPageView:function(t){e.logger.debug("GAN-page: "+t),e.analytics.connector.trackPageView(t)},trackEvent:function(t,n,r,i){n=(_.isEmpty(n)&&r?r.currentTarget.id:n)||"[unknown]",e.logger.debug("GAN-event: "+t+":"+n+"("+i+")"+" on "+this.currentViewId),e.analytics.connector.trackEvent({category:t,action:n,label:this.currentViewId,value:i})},detachAnalytics:function(e){var t=this.getTrackableElements(e);t.unbind(".analytics")},attachAnalytics:function(e){var t=this,n=this.getTrackableElements(e);n.unbind(".analytics"),n.each(function(e,n){t._attachAnalytics(n)})},getTrackableElements:function(e){var t=this._getTrackableElements(e);return e.attr("track")&&(t=t.add(e)),t},_getTrackableElements:function(e){return $("[track]",e)},_attachAnalytics:function(e){var t=$(e),n=(t.attr("track")||"").trim();if(n==="")return;var r=this.parseTrackTag(n);this._attachEvents(r.events,r.action,r.css,t)},parseTrackTag:function(e){var t={events:"",action:"",css:""},n=e.split(":"),r=n[1]?n[1].split("."):n[0].split(".");t.events=n[0],t.action=r[0],t.css=r[1]||"";var i=t.events.replace(this.eventSplitter," ").split(" ");return i=_.map(i,function(e){return e+".analytics"}),t.events=i.join(" "),t},_attachEvents:function(t,n,r,i){t&&(i.off(t),i.on(t,function(t){e.analytics.trackEvent(t.type,n,t,r&&$(this).hasClass(r)?1:0)}))}};e.augment("analytics",t,!1)})(SUGAR.App),function(e){var t;e.analytics=e.analytics||{},e.analytics.connectors=e.analytics.connectors||{},e.analytics.connectors.GoogleAnalytics={initialize:function(){(function(e,t,n,r,i,s,o){e.GoogleAnalyticsObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,s=t.createElement(n),o=t.getElementsByTagName(n)[0],s.async=1,s.src=r,o.parentNode.insertBefore(s,o)})(window,document,"script","//www.google-analytics.com/analytics.js","ga")},start:function(e,n){ga("create",e,"none"),t=n.optOut,t&&(window["ga-disable-"+e]=!0)},trackPageView:function(e){ga("send","pageview",e)},trackEvent:function(e){ga("send","event",e.category,e.action,e.label,e.value)}},e.analytics.connectors.GoogleAnalyticsTraditional={initialize:function(){_gaq=_gaq||[],function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"===document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()},start:function(e,n){_gaq.push(["_setAccount",e]),_gaq.push(["_setDomainName","none"]),t=n.optOut},trackPageView:function(e){t||_gaq.push(["_trackPageview",e])},trackEvent:function(e){t||_gaq.push(["_trackEvent",e.category,e.action,e.label,e.value])}}}(SUGAR.App),function(e){var t=function(t,n){this.options=e.extend({},e.fn.searchahead.defaults,n),this.$element=e(t),this.request=this.options.request,this.compiler=this.options.compiler,this.context=n.context||null,this.$button=this.options.buttonElement?e(this.options.buttonElement):null,this.throttle=this.options.throttle||this.throttle,this.throttleMillis=this.options.throttleMillis||this.throttleMillis,this.$menu=e(this.options.menu).appendTo(this.$element.parent().next(".typeahead-wrapper")),this.shown=!1,this.minChars=this.options.minChars||1,this.patchIfZepto(),this.listen(),this.onEnterFn=this.options.onEnterFn||null};t.prototype={constructor:t,compile:function(e){return this.compiler({data:e,term:encodeURIComponent(this.query)})},disabled:!1,enable:function(){this.disabled=!1},disable:function(e){var t=this;t.disabled=!0,t.hide(),setTimeout(function(){t.hide()},t.throttleMillis),setTimeout(function(){t.enable()},e)},throttleMillis:250,throttle:function(e,t){var n=null;n=setTimeout(function(){e()},t)},go:function(){var e=null,t=null,n=null;return e=this.$menu.find(".active"),t=e.find("a").attr("href"),t?this.onEnterFn?this.context?this.onEnterFn.call(this.context,t,!0):this.onEnterFn(t,!0):window.location=t:(n=encodeURIComponent(this.$element.val()),n&&n.length&&this.onEnterFn&&(this.context?this.onEnterFn.call(this.context,n,!1):this.onEnterFn(n,!1))),this.hide()},show:function(){return this.$menu.show(),this.shown=!0,this.disabled?null:(this.$menu.show(),this.shown=!0,this)},hide:function(){return this.$menu.hide(),this.shown=!1,this},buttonLookup:function(e){e.stopPropagation(),e.preventDefault(),this.lookup(e),this.$element.focus()},lookup:function(e){var t=this,n;this.query=this.$element.val();if(!this.query)return this.shown?this.hide():this;this.onSearch(e)},onSearch:function(t){var n=this;e.inArray(t.keyCode,[40,38,9,13,27])===-1&&(t.preventDefault(),n.throttle(function(){n.query=n.$element.val(),n.query&&n.query.length>=n.minChars?n.context?n.request.call(n.context,n.query):n.request(n.query):n.hide()},n.throttleMillis))},provide:function(e){var t,n=this.compile(e),r=this;t=n.replace(/^\s+/,"").replace(/\s+$/,"");if(t.length){r.$menu.html(n);if(!r.disabled)return r.show()}return null},move:function(t,n){var r=this.$menu.find(".active").removeClass("active"),i;n==="next"?i=r.next():i=r.prev(),i.length||(i=e(this.$menu.find("li")[0])),i.addClass("active")},next:function(e){this.move(e,"next")},prev:function(e){this.move(e,"prev")},patchIfZepto:function(){_.isUndefined(window.Zepto)||(e.support={},e.proxy=function(t,n){var r,i,s;return typeof n=="string"&&(i=t[n],n=t,t=i),e.isFunction(t)?(r=Array.prototype.slice.call(arguments,2),s=function(){return t.apply(n,r.concat(Array.prototype.slice.call(arguments)))},s.guid=t.guid=t.guid||s.guid||e.guid++,s):undefined})},listen:function(){this.$element.on("blur",e.proxy(this.blur,this)).on("keypress",e.proxy(this.keypress,this)).on("keyup",e.proxy(this.keyup,this)),(e.browser.webkit||e.browser.msie)&&this.$element.on("keydown",e.proxy(this.keypress,this)),this.$button&&(this.$button.on("click",e.proxy(this.buttonLookup,this)),app.accessibility&&app.accessibility.run(this.$button,"click")),this.$menu.on("mouseenter","li",e.proxy(this.mouseenter,this))},keyup:function(e){switch(e.keyCode){case 40:case 38:break;case 9:if(!this.options.tabToSelect)break;case 13:if(this.onEnterFn){this.go();break}if(!this.shown)return;this.lookup(e);break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup(e)}e.stopPropagation(),e.preventDefault()},keypress:function(e){if(!this.shown)return;switch(e.keyCode){case 9:case 13:case 27:e.preventDefault();break;case 38:if(e.type!=="keydown")break;e.preventDefault(),this.prev();break;case 40:if(e.type!=="keydown")break;e.preventDefault(),this.next()}e.stopPropagation()},blur:function(e){var t=this;setTimeout(function(){t.hide()},500)},mouseenter:function(t){this.$menu.find(".active").removeClass("active"),e(t.currentTarget).addClass("active")}},e.fn.searchahead=function(){var n=arguments[0],r=Array.prototype.slice.call(arguments,1);return this.each(function(){var i=e(this),s=i.data("searchahead"),o=typeof n=="object"&&n;s||i.data("searchahead",s=new t(this,o)),typeof n=="string"&&s[n].apply(s,r)})},e.fn.searchahead.defaults={items:10,menu:'<ul class="typeahead dropdown-menu"></ul>'},e.fn.searchahead.Constructor=t}(window.$),function(e){e(jQuery||Zepto,SUGAR.App.date)}(function(e,t){var n=6e4,r=e([]),i,s=function(){if(!r.length)return;i=setTimeout(s,n),o.update()},o={update:function(n){n=n||r,n.each(function(n,i){var s=e(i),o=s.data("liveRelativeDate"),u;if(!o){r=r.not(i);return}u=o.date?s.data(o.date):s.attr("datetime");var a=s.html(),f=t(u).fromNow();if(a===f)return;var l=e.Event("change.liveRelativeDate");s.trigger(l,[a,f]),l.isDefaultPrevented()||s.html(f)})},pause:function(){clearTimeout(i),i=null},resume:function(){i||s()},interval:function(e){if(e===undefined)return n;n=e}},u={add:function(e,t){return!e||e.length===0?e:(t=t||{},e.data("liveRelativeDate",t),r=r.add(e),o.resume(),e)},destroy:function(t){return r=r.not(t),t.each(function(t){e(t).removeData("liveRelativeDate")}),t},isLiveRelativeDate:function(t){var n=!0;return e.each(t,function(t){if(e(t).data("liveRelativeDate")===undefined)return n=!1,!0}),n}};e.liverelativedate=o,e.fn.liverelativedate=function(e,t){return u[e]||(t=e,e="add"),u[e](this,t)}}),SUGAR=SUGAR||{},function(e){e.util=e.util||{};var t=e.util.ajaxCallInProgress;e.util.ajaxCallInProgress=function(){return t&&t()?!0:SUGAR.Api.getCallsInProgressCount()>0}}(SUGAR),function(e){e.augment("accessibility",{init:function(e){e.accessibility.helpers&&!_.isEmpty(e.accessibility.helpers)&&(e.view.Component.prototype.initialize=_.wrap(e.view.Component.prototype.initialize,function(t,n){t.call(this,n),this.on("render",function(){e.accessibility.run(this)},this)}))},run:function(t,n){var r=this.whichHelpers(n);_.each(r,function(n,r){_.isFunction(n.run)?(e.logger.debug("Applying accessibility helper `"+r+"`"),n.run(t)):e.logger.debug("Unable to apply accessibility helper `"+r+"`")})},whichHelpers:function(t){var n;return _.isUndefined(t)?e.accessibility.helpers:(_.isArray(t)||(t=[t]),n=_.reduce(t,function(t,n){return!e.accessibility.helpers[n]||(t[n]=e.accessibility.helpers[n]),t},{}),n)},getElementTag:function(e){var t=(e.prop("tagName")||"").toLowerCase(),n=[t];if(e[0]&&e[0].attributes)_.each(e[0].attributes,function(e){n.push("["+e.name+'="'+e.value+'"]')});else if(e.selector)return e.selector;return n.join("")}},!1)}(SUGAR.App),function(e){e.accessibility=e.accessibility||{},e.accessibility.helpers=e.accessibility.helpers||{},e.accessibility.helpers.click={run:function(t){var n=this,r=t instanceof e.view.Component?t.$el:t,i=r.data("events");if(!i||!i.click){e.logger.debug("Found no events on "+e.accessibility.getElementTag(r));return}_.each(i.click,function(e){e.selector?r.find(e.selector).each(function(){n._makeElementCompliant($(this))}):n._makeElementCompliant(r)})},_isElementCompliant:function(t){var n=t.prop("tagName");if(!n)return e.logger.debug("The element does not have a tag name"),!0;switch(n.toLowerCase()){case"button":case"input":case"select":case"textarea":return!0;case"a":case"area":return!!t.attr("href");default:return t[0].hasAttribute("tabindex")}},_makeElementCompliant:function(t){var n=e.accessibility.getElementTag(t);this._isElementCompliant(t)?e.logger.debug("Found "+n+" to be compliant"):(e.logger.debug("Made "+n+" compliant"),t.attr("tabindex",-1))}}}(SUGAR.App),function(e){e.accessibility=e.accessibility||{},e.accessibility.helpers=e.accessibility.helpers||{},e.accessibility.helpers.label={run:function(t){var n=this;if(!(t instanceof e.view.Field))return;t.label&&t.fieldTag&&t.$el.find(t.fieldTag).each(function(){n._makeElementCompliant($(this),t.label)})},_isElementCompliant:function(e){var t=e.prop("tagName").toLowerCase(),n=e.attr("aria-label");return!_.contains(["input","button","select","textarea"],t)||!_.isUndefined(n)},_makeElementCompliant:function(e,t){this._isElementCompliant(e)||e.attr("aria-label",t)}}}(SUGAR.App),function(e,t,n){function r(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)}function i(e){if("keypress"==e.type){var t=String.fromCharCode(e.which);return e.shiftKey||(t=t.toLowerCase()),t}return d[e.which]?d[e.which]:v[e.which]?v[e.which]:String.fromCharCode(e.which).toLowerCase()}function s(e){e=e||{};var t=!1,n;for(n in E)e[n]?t=!0:E[n]=0;t||(N=!1)}function o(e,t,n,r,i,s){var o,u,a=[],f=n.type;if(!b[e])return[];"keyup"==f&&l(e)&&(t=[e]);for(o=0;o<b[e].length;++o)if(u=b[e][o],!(!r&&u.seq&&E[u.seq]!=u.level||f!=u.action||("keypress"!=f||n.metaKey||n.ctrlKey)&&t.sort().join(",")!==u.modifiers.sort().join(","))){var c=r&&u.seq==r&&u.level==s;(!r&&u.combo==i||c)&&b[e].splice(o,1),a.push(u)}return a}function u(e){var t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t}function a(e,t,n,r){C.stopCallback(t,t.target||t.srcElement,n,r)||!1!==e(t,n)||(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation?t.stopPropagation():t.cancelBubble=!0)}function f(e){"number"!=typeof e.which&&(e.which=e.keyCode);var t=i(e);t&&("keyup"==e.type&&x===t?x=!1:C.handleKey(t,u(e),e))}function l(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function c(e,t,n,r){function o(t){return function(){N=t,++E[e],clearTimeout(S),S=setTimeout(s,1e3)}}function u(t){a(n,t,e),"keyup"!==r&&(x=i(t)),setTimeout(s,10)}for(var f=E[e]=0;f<t.length;++f){var l=f+1===t.length?u:o(r||h(t[f+1]).action);p(t[f],l,r,e,f)}}function h(e,t){var n,r,i,s=[];n="+"===e?["+"]:e.split("+");for(i=0;i<n.length;++i)r=n[i],g[r]&&(r=g[r]),t&&"keypress"!=t&&m[r]&&(r=m[r],s.push("shift")),l(r)&&s.push(r);n=r,i=t;if(!i){if(!y){y={};for(var o in d)95<o&&112>o||d.hasOwnProperty(o)&&(y[d[o]]=o)}i=y[n]?"keydown":"keypress"}return"keypress"==i&&s.length&&(i="keydown"),{key:r,modifiers:s,action:i}}function p(e,t,n,r,i){w[e+":"+n]=t,e=e.replace(/\s+/g," ");var s=e.split(" ");1<s.length?c(e,s,t,n):(n=h(e,n),b[n.key]=b[n.key]||[],o(n.key,n.modifiers,{type:n.action},r,e,i),b[n.key][r?"unshift":"push"]({callback:t,modifiers:n.modifiers,action:n.action,seq:r,level:i,combo:e}))}var d={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},v={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},m={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},g={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},y,b={},w={},E={},S,x=!1,T=!1,N=!1;for(n=1;20>n;++n)d[111+n]="f"+n;for(n=0;9>=n;++n)d[n+96]=n;r(t,"keypress",f),r(t,"keydown",f),r(t,"keyup",f);var C={bind:function(e,t,n){e=e instanceof Array?e:[e];for(var r=0;r<e.length;++r)p(e[r],t,n);return this},unbind:function(e,t){return C.bind(e,function(){},t)},trigger:function(e,t){return w[e+":"+t]&&w[e+":"+t]({},e),this},reset:function(){return b={},w={},this},stopCallback:function(e,t){return-1<(" "+t.className+" ").indexOf(" mousetrap ")?!1:"INPUT"==t.tagName||"SELECT"==t.tagName||"TEXTAREA"==t.tagName||t.isContentEditable},handleKey:function(e,t,n){var r=o(e,t,n),i;t={};var u=0,f=!1;for(i=0;i<r.length;++i)r[i].seq&&(u=Math.max(u,r[i].level));for(i=0;i<r.length;++i)r[i].seq?r[i].level==u&&(f=!0,t[r[i].seq]=1,a(r[i].callback,n,r[i].combo,r[i].seq)):f||a(r[i].callback,n,r[i].combo);r="keypress"==n.type&&T,n.type!=N||l(e)||r||s(t),T=f&&"keydown"==n.type}};e.Mousetrap=C,"function"==typeof define&&define.amd&&define(C)}(window,document),function(e){var t=function(e,t,n){var r=_.wrap(t,function(e){var t=Array.prototype.slice.call(arguments,1);return n.disposed||e.apply(n,t),!1});Mousetrap.bind(e,r)},n=function(e){Mousetrap.unbind(e)},r=function(e,t){var n=!1,r=_.find(e,function(e,n){return _.contains(e.keys,t)});return r&&(n=!!r.callOnFocus),n},i=Mousetrap.stopCallback;Mousetrap.stopCallback=function(t,n,r){var s=function(){return n.tagName==="INPUT"||n.tagName==="SELECT"||n.tagName==="TEXTAREA"||n.isContentEditable};return e.shortcuts.isEnabled()?s()&&e.shortcuts.shouldCallOnFocus(r)?($(n).blur(),!1):i(t,n):!0},e.events.on("app:login:success",function(){e.shortcuts.enable()}),e.events.on("app:logout:success",function(){e.shortcuts.disable()}),e.events.once("app:init",function(){e.before("app:view:change",function(){return e.shortcuts.clearSession(),!0})}),e.augment("shortcuts",{GLOBAL:"Global:",_currentSession:null,_savedSessions:[],_globalShortcuts:{},_enable:!1,createSession:function(e,t){var n=this;this.clearSession(),this._currentSession=new s(e,t),this._currentSession.activate(),t._dispose=_.wrap(t._dispose,function(e){var r=Array.prototype.slice.call(arguments,1);e.apply(t,r),n.deleteSavedSession(t)})},clearSession:function(){this._currentSession&&(this._currentSession.deactivate(),this._currentSession=null)},register:function(e,n,r,i,s){var o;_.isArray(n)||(n=[n]);if(this._isGlobalShortcutKey(n))return;e.indexOf(this.GLOBAL)===0?(this._globalShortcuts[e]={keys:n,func:r,component:i},s&&(this._globalShortcuts[e].callOnFocus=s),t(n,r,i)):(o=this._getShortcutSessionForComponent(i),o&&o.register(e,n,r,i,s))},unregister:function(e,t){var n=this._getShortcutSessionForComponent(t);n&&n.unregister(e)},saveSession:function(){this._savedSessions.push(this._currentSession),this.clearSession()},restoreSession:function(){if(this._savedSessions.length===0)return;this.clearSession(),this._currentSession=this._savedSessions.pop();if(!this._currentSession)return;this._currentSession.layout.disposed?this.restoreSession():this._currentSession.activate()},enable:function(){this._enable=!0},disable:function(){this._enable=!1},isEnabled:function(){return this._enable},getCurrentSession:function(){return this._currentSession},getLastSavedSession:function(){return _.last(this._savedSessions)},deleteSavedSession:function(e){var t,n;for(var r=0;r<this._savedSessions.length;r++){n=this._savedSessions[r];if(n&&n.layout===e){t=r;break}}_.isUndefined(t)||this._savedSessions.splice(t,1)},getRegisteredGlobalShortcuts:function(){return _.map(this._globalShortcuts,function(e,t){return{id:t,keys:e.keys}})},shouldCallOnFocus:function(e){var t=!1;return this._currentSession&&(t=this._currentSession.shouldCallOnFocus(e)),t||(t=r(this._globalShortcuts,e)),t},_getShortcutSessionForComponent:function(t){var n,r=e.utils.getParentLayout(t);return this._currentSession&&this._currentSession.layout===t?n=this._currentSession:n=_.find(this._savedSessions,function(e){return e&&e.layout===t}),_.isUndefined(n)&&r&&(n=this._getShortcutSessionForComponent(r)),n},_isGlobalShortcutKey:function(e){return!_.every(e,function(e){return _.every(this._globalShortcuts,function(t){return _.indexOf(t.keys,e)===-1})},this)}},!1);var s=function(e,t){this.layout=t,this._active=!1,this._shortcuts={},_.each(e,function(e){this._allowShortcut(e)},this)};_.extend(s.prototype,{activate:function(){this.deactivate(),this._active=!0,_.each(this._shortcuts,function(e){_.isEmpty(e)||t(e.keys,e.func,e.component)},this)},deactivate:function(){this.isActive()&&(_.each(this._shortcuts,function(e){_.each(e.keys,function(e){n(e)})},this),this._active=!1)},isActive:function(){return this._active},register:function(e,t,n,r,i){if(!this._isShortcutAllowed(e)||this._isInDashboard(r))return;_.isArray(t)||(t=[t]),this.unregister(e),this._bindShortcutKeys(e,t,n,r,i)},unregister:function(e){if(!this._isShortcutAllowed(e))return;this.isActive()&&_.each(this._shortcuts[e].keys,function(e){n(e)}),this._shortcuts[e]={}},getRegisteredShortcuts:function(){var e=[];return _.each(this._shortcuts,function(t,n){_.isEmpty(t)||e.push({id:n,keys:t.keys})}),e},shouldCallOnFocus:function(e){var t=!1;return this.isActive()&&(t=r(this._shortcuts,e)),t},_bindShortcutKeys:function(e,n,r,i,s){if(!this._isShortcutAllowed(e))return;this._shortcuts[e].keys=n,this._shortcuts[e].func=r,this._shortcuts[e].component=i,s&&(this._shortcuts[e].callOnFocus=s),this.isActive()&&t(n,r,i)},_allowShortcut:function(e){this._shortcuts[e]={}},_isShortcutAllowed:function(e){return!_.isUndefined(this._shortcuts[e])},_isInDashboard:function(e){var t=e.layout||!_.isUndefined(e.view)&&e.view.layout;return t.type==="dashlet"||t.type==="dashboard"}})}(SUGAR.App);